# 💾 数据持久化系统 v2.0

> **版本**: 2.0.0  
> **更新时间**: 2025-10-20  
> **架构**: 前后端分离 + 多存储方案

---

## 🎯 系统概述

新版数据持久化系统支持：
- ✅ **三种存储模式**: LocalStorage、IndexedDB、Cloud (服务器)
- ✅ **数据压缩**: 自动压缩大于100KB的数据
- ✅ **多存档槽位**: 支持3个独立存档
- ✅ **云同步**: 自动同步到服务器
- ✅ **版本控制**: 同步历史记录
- ✅ **冲突解决**: 智能合并本地和云端数据

---

## 📦 存储方案对比

| 特性 | LocalStorage | IndexedDB | Cloud |
|------|-------------|-----------|-------|
| **容量** | ~5-10MB | 50MB-1GB+ | 无限制 |
| **性能** | 同步 | 异步（更快） | 网络延迟 |
| **离线** | ✅ | ✅ | ❌ |
| **多设备同步** | ❌ | ❌ | ✅ |
| **数据压缩** | ✅ | ✅ | ✅ |
| **版本历史** | ❌ | ❌ | ✅ |
| **推荐用途** | 简单设置 | 本地游戏存档 | 跨设备同步 |

---

## 🚀 快速开始

### 1. 基础使用

```typescript
import { storageManager } from '@/services/storageManager';

// 保存游戏（自动保存到槽位1）
await storageManager.save(1, gameState, '我的第一个存档');

// 加载游戏
const gameData = await storageManager.load(1);

// 获取所有存档槽位信息
const slots = await storageManager.getSaveSlots();
console.log(slots);
// [
//   { slotNumber: 1, saveName: '我的第一个存档', hasData: true, ... },
//   { slotNumber: 2, saveName: '存档槽位 2', hasData: false, ... },
//   { slotNumber: 3, saveName: '存档槽位 3', hasData: false, ... }
// ]
```

### 2. 自定义配置

```typescript
import { StorageManager } from '@/services/storageManager';

const customStorage = new StorageManager({
  mode: 'indexeddb',           // 存储模式
  username: 'Player123',        // 用户名
  enableCompression: true,      // 启用压缩
  enableCloudSync: true,        // 启用云同步
  apiUrl: 'http://localhost:3000/api',  // API地址
});

await customStorage.save(1, gameState);
```

---

## 🗂️ 多存档槽位系统

### 槽位管理

```typescript
// 获取所有槽位
const slots = await storageManager.getSaveSlots();

// 保存到不同槽位
await storageManager.save(1, gameState, '主线剧情');
await storageManager.save(2, gameState, '探索模式');
await storageManager.save(3, gameState, '速通挑战');

// 重命名存档
await storageManager.renameSave(1, '主线剧情 - 第二章');

// 删除存档
await storageManager.deleteSave(2);
```

### 槽位信息结构

```typescript
interface SaveSlotInfo {
  slotNumber: number;          // 槽位号 (1-3)
  saveName: string;            // 存档名称
  hasData: boolean;            // 是否有数据
  updatedAt: number;           // 更新时间戳
  preview?: {                  // 预览信息
    level: number;             // 玩家等级
    exploredCount: number;     // 探索区域数
  };
}
```

---

## 📊 数据压缩

### 自动压缩

数据大小超过 **100KB** 时自动使用 gzip 压缩：

```typescript
// 自动处理，无需手动调用
await storageManager.save(1, largeGameData);
// 📦 数据压缩: 250000 -> 65000 bytes (74.0%)
```

### 手动压缩

```typescript
import { compressData, decompressData } from '@/services/compression';

// 压缩
const compressed = compressData(gameData);
console.log(compressed);
// {
//   compressed: true,
//   data: "H4sIAAAAAAAA...",  // base64
//   originalSize: 250000,
//   compressedSize: 65000
// }

// 解压
const original = decompressData(compressed);
```

---

## ☁️ 云同步功能

### 启用云同步

```typescript
const storage = new StorageManager({
  mode: 'indexeddb',
  username: 'Player123',
  enableCloudSync: true,  // 启用云同步
});

// 保存时自动上传到云端
await storage.save(1, gameState);
// ✅ 游戏已保存到槽位 1
// ☁️ 已同步到云端
```

### 手动同步操作

```typescript
import { CloudSyncClient } from '@/services/cloudSync';

const syncClient = new CloudSyncClient({ username: 'Player123' });

// 上传到云端
await syncClient.uploadToCloud(1, gameData);
// ✅ 存档已上传到云端 (版本 5)

// 从云端下载
const cloudData = await syncClient.downloadFromCloud(1);

// 下载特定版本
const oldVersion = await syncClient.downloadFromCloud(1, 3);

// 获取同步历史
const history = await syncClient.getSyncHistory(1, 10);
console.log(history);
// [
//   { sync_version: 5, synced_at: 1697000005000, ... },
//   { sync_version: 4, synced_at: 1697000004000, ... },
//   ...
// ]
```

### 冲突检测和解决

```typescript
// 检查冲突
const conflict = await syncClient.checkConflict(1, localVersion, localTimestamp);

if (conflict.hasConflict) {
  console.log('检测到冲突！');
  console.log(`本地版本: ${localVersion}, 云端版本: ${conflict.cloudVersion}`);
  
  // 智能同步（自动解决冲突）
  const result = await syncClient.syncSave(1, localData, localVersion, localTimestamp);
  
  if (result.action === 'uploaded') {
    console.log('本地数据已上传');
  } else if (result.action === 'downloaded') {
    console.log('已下载云端数据:', result.data);
  }
}
```

---

## 🗄️ IndexedDB 详解

### 初始化

```typescript
import { initIndexedDB } from '@/services/indexedDB';

// 初始化数据库（自动调用）
const db = await initIndexedDB();
// ✅ IndexedDB initialized
```

### 直接操作

```typescript
import {
  saveToIndexedDB,
  loadFromIndexedDB,
  getAllSaveSlots,
  deleteFromIndexedDB,
  renameSaveInIndexedDB,
  getStorageUsage,
} from '@/services/indexedDB';

// 保存
await saveToIndexedDB(1, gameData, '我的存档');

// 加载
const data = await loadFromIndexedDB(1);

// 获取所有槽位
const slots = await getAllSaveSlots();

// 删除
await deleteFromIndexedDB(1);

// 重命名
await renameSaveInIndexedDB(1, '新名称');

// 查看存储使用情况
const usage = await getStorageUsage();
console.log(usage);
// {
//   usage: 1048576,           // 1MB
//   quota: 52428800,          // 50MB
//   usagePercent: 2,
//   formattedUsage: '1.00 MB',
//   formattedQuota: '50.00 MB'
// }
```

---

## 🔄 导出/导入功能

### 导出存档

```typescript
// 导出为JSON字符串
const json = await storageManager.exportSave(1);

// 保存到文件
const blob = new Blob([json], { type: 'application/json' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `save-slot-1-${Date.now()}.json`;
a.click();
```

### 导入存档

```typescript
// 从文件读取
const file = event.target.files[0];
const json = await file.text();

// 导入到槽位2
await storageManager.importSave(2, json, '导入的存档');
// ✅ 存档导入成功
```

---

## 🎮 在游戏中集成

### 1. 初始化存储管理器

```typescript
// src/main.tsx 或 App.tsx
import { storageManager } from '@/services/storageManager';

// 配置存储管理器
const username = import.meta.env.VITE_USERNAME || 'Player';
const storageMode = import.meta.env.VITE_STORAGE_MODE || 'indexeddb';

storageManager.switchMode(storageMode);
```

### 2. 保存游戏

```typescript
// 在 gameStore.ts 或组件中
import { useGameStore } from '@/store/gameStore';
import { storageManager } from '@/services/storageManager';

const saveGame = async (slotNumber: number) => {
  const state = useGameStore.getState();
  
  // 准备要保存的数据
  const saveData = {
    player: state.player,
    playerPosition: state.playerPosition,
    inventory: state.inventory,
    quests: state.quests,
    progress: state.progress,
    settings: state.settings,
  };
  
  try {
    await storageManager.save(slotNumber, saveData, '当前游戏');
    console.log('✅ 游戏保存成功！');
  } catch (error) {
    console.error('❌ 保存失败:', error);
  }
};
```

### 3. 加载游戏

```typescript
const loadGame = async (slotNumber: number) => {
  try {
    const saveData = await storageManager.load(slotNumber);
    
    // 更新游戏状态
    useGameStore.setState({
      player: saveData.player,
      playerPosition: saveData.playerPosition,
      inventory: saveData.inventory,
      quests: saveData.quests,
      progress: saveData.progress,
      settings: saveData.settings,
    });
    
    console.log('✅ 游戏加载成功！');
  } catch (error) {
    console.error('❌ 加载失败:', error);
  }
};
```

### 4. 自动保存

```typescript
// 设置自动保存（每5分钟）
useEffect(() => {
  const autoSave = setInterval(async () => {
    await saveGame(1);  // 自动保存到槽位1
  }, 5 * 60 * 1000);  // 5分钟
  
  return () => clearInterval(autoSave);
}, []);
```

---

## 📡 服务器API

### 保存到服务器

```typescript
import { SaveAPI } from '@/services/cloudSync';

const api = new SaveAPI('Player123');

// 保存
await api.saveGame(1, gameData, '我的存档');

// 加载
const data = await api.loadGame(1);

// 获取槽位列表
const slots = await api.getSaveSlots();

// 删除
await api.deleteSave(1);

// 重命名
await api.renameSave(1, '新名称');
```

---

## 🔧 高级配置

### 切换存储模式

```typescript
// 运行时切换
storageManager.switchMode('cloud');  // 切换到云端模式
storageManager.switchMode('local');  // 切换到LocalStorage
storageManager.switchMode('indexeddb');  // 切换到IndexedDB
```

### 获取存储信息

```typescript
const info = await storageManager.getStorageInfo();
console.log(info);
// {
//   usage: 1048576,
//   quota: 52428800,
//   usagePercent: 2,
//   formattedUsage: '1.00 MB',
//   formattedQuota: '50.00 MB'
// }
```

---

## ⚠️ 注意事项

### 1. 浏览器兼容性

- **IndexedDB**: 所有现代浏览器支持
- **LocalStorage**: 所有浏览器支持
- **数据压缩**: 需要支持 `pako` 库

### 2. 数据大小限制

| 存储方式 | 限制 |
|---------|------|
| LocalStorage | ~5-10MB |
| IndexedDB | 至少50MB，通常更多 |
| Cloud | 无限制（受服务器配置影响） |

### 3. 性能建议

- 使用 IndexedDB 作为主要存储
- 启用数据压缩
- 定期清理旧的云同步记录
- 大型存档分块保存

### 4. 安全性

- 云同步使用 SHA-256 校验数据完整性
- 不在客户端存储敏感信息
- 使用 HTTPS 传输数据

---

## 🐛 故障排除

### IndexedDB 初始化失败

```typescript
// 自动降级到 LocalStorage
if (error) {
  console.log('降级到LocalStorage模式');
  storageManager.switchMode('local');
}
```

### 云同步失败

```typescript
try {
  await syncClient.uploadToCloud(1, gameData);
} catch (error) {
  console.warn('云同步失败（将在后台重试）:', error);
  // 数据仍然保存在本地
}
```

### 存档损坏

```typescript
try {
  const data = await storageManager.load(1);
} catch (error) {
  console.error('存档可能已损坏');
  // 尝试从云端恢复
  const cloudData = await syncClient.downloadFromCloud(1);
}
```

---

## 📈 性能优化

### 压缩率统计

```typescript
import { calculateCompressionRatio, formatSize } from '@/services/compression';

const ratio = calculateCompressionRatio(originalSize, compressedSize);
console.log(`压缩率: ${ratio.toFixed(1)}%`);
console.log(`原始大小: ${formatSize(originalSize)}`);
console.log(`压缩后: ${formatSize(compressedSize)}`);
```

### 批量操作

```typescript
// 批量保存多个槽位
await Promise.all([
  storageManager.save(1, data1),
  storageManager.save(2, data2),
  storageManager.save(3, data3),
]);
```

---

## 🔗 相关文档

- [后端API文档](../backend/README.md)
- [迁移指南](../MIGRATION_GUIDE.md)
- [项目重构说明](../PROJECT_RESTRUCTURE.md)

---

**"数据永不丢失，冒险永不停歇！"** 💾✨
