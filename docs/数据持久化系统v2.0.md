# ğŸ’¾ æ•°æ®æŒä¹…åŒ–ç³»ç»Ÿ v2.0

> **ç‰ˆæœ¬**: 2.0.0  
> **æ›´æ–°æ—¶é—´**: 2025-10-20  
> **æ¶æ„**: å‰åç«¯åˆ†ç¦» + å¤šå­˜å‚¨æ–¹æ¡ˆ

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

æ–°ç‰ˆæ•°æ®æŒä¹…åŒ–ç³»ç»Ÿæ”¯æŒï¼š
- âœ… **ä¸‰ç§å­˜å‚¨æ¨¡å¼**: LocalStorageã€IndexedDBã€Cloud (æœåŠ¡å™¨)
- âœ… **æ•°æ®å‹ç¼©**: è‡ªåŠ¨å‹ç¼©å¤§äº100KBçš„æ•°æ®
- âœ… **å¤šå­˜æ¡£æ§½ä½**: æ”¯æŒ3ä¸ªç‹¬ç«‹å­˜æ¡£
- âœ… **äº‘åŒæ­¥**: è‡ªåŠ¨åŒæ­¥åˆ°æœåŠ¡å™¨
- âœ… **ç‰ˆæœ¬æ§åˆ¶**: åŒæ­¥å†å²è®°å½•
- âœ… **å†²çªè§£å†³**: æ™ºèƒ½åˆå¹¶æœ¬åœ°å’Œäº‘ç«¯æ•°æ®

---

## ğŸ“¦ å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | LocalStorage | IndexedDB | Cloud |
|------|-------------|-----------|-------|
| **å®¹é‡** | ~5-10MB | 50MB-1GB+ | æ— é™åˆ¶ |
| **æ€§èƒ½** | åŒæ­¥ | å¼‚æ­¥ï¼ˆæ›´å¿«ï¼‰ | ç½‘ç»œå»¶è¿Ÿ |
| **ç¦»çº¿** | âœ… | âœ… | âŒ |
| **å¤šè®¾å¤‡åŒæ­¥** | âŒ | âŒ | âœ… |
| **æ•°æ®å‹ç¼©** | âœ… | âœ… | âœ… |
| **ç‰ˆæœ¬å†å²** | âŒ | âŒ | âœ… |
| **æ¨èç”¨é€”** | ç®€å•è®¾ç½® | æœ¬åœ°æ¸¸æˆå­˜æ¡£ | è·¨è®¾å¤‡åŒæ­¥ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€ä½¿ç”¨

```typescript
import { storageManager } from '@/services/storageManager';

// ä¿å­˜æ¸¸æˆï¼ˆè‡ªåŠ¨ä¿å­˜åˆ°æ§½ä½1ï¼‰
await storageManager.save(1, gameState, 'æˆ‘çš„ç¬¬ä¸€ä¸ªå­˜æ¡£');

// åŠ è½½æ¸¸æˆ
const gameData = await storageManager.load(1);

// è·å–æ‰€æœ‰å­˜æ¡£æ§½ä½ä¿¡æ¯
const slots = await storageManager.getSaveSlots();
console.log(slots);
// [
//   { slotNumber: 1, saveName: 'æˆ‘çš„ç¬¬ä¸€ä¸ªå­˜æ¡£', hasData: true, ... },
//   { slotNumber: 2, saveName: 'å­˜æ¡£æ§½ä½ 2', hasData: false, ... },
//   { slotNumber: 3, saveName: 'å­˜æ¡£æ§½ä½ 3', hasData: false, ... }
// ]
```

### 2. è‡ªå®šä¹‰é…ç½®

```typescript
import { StorageManager } from '@/services/storageManager';

const customStorage = new StorageManager({
  mode: 'indexeddb',           // å­˜å‚¨æ¨¡å¼
  username: 'Player123',        // ç”¨æˆ·å
  enableCompression: true,      // å¯ç”¨å‹ç¼©
  enableCloudSync: true,        // å¯ç”¨äº‘åŒæ­¥
  apiUrl: 'http://localhost:3000/api',  // APIåœ°å€
});

await customStorage.save(1, gameState);
```

---

## ğŸ—‚ï¸ å¤šå­˜æ¡£æ§½ä½ç³»ç»Ÿ

### æ§½ä½ç®¡ç†

```typescript
// è·å–æ‰€æœ‰æ§½ä½
const slots = await storageManager.getSaveSlots();

// ä¿å­˜åˆ°ä¸åŒæ§½ä½
await storageManager.save(1, gameState, 'ä¸»çº¿å‰§æƒ…');
await storageManager.save(2, gameState, 'æ¢ç´¢æ¨¡å¼');
await storageManager.save(3, gameState, 'é€Ÿé€šæŒ‘æˆ˜');

// é‡å‘½åå­˜æ¡£
await storageManager.renameSave(1, 'ä¸»çº¿å‰§æƒ… - ç¬¬äºŒç« ');

// åˆ é™¤å­˜æ¡£
await storageManager.deleteSave(2);
```

### æ§½ä½ä¿¡æ¯ç»“æ„

```typescript
interface SaveSlotInfo {
  slotNumber: number;          // æ§½ä½å· (1-3)
  saveName: string;            // å­˜æ¡£åç§°
  hasData: boolean;            // æ˜¯å¦æœ‰æ•°æ®
  updatedAt: number;           // æ›´æ–°æ—¶é—´æˆ³
  preview?: {                  // é¢„è§ˆä¿¡æ¯
    level: number;             // ç©å®¶ç­‰çº§
    exploredCount: number;     // æ¢ç´¢åŒºåŸŸæ•°
  };
}
```

---

## ğŸ“Š æ•°æ®å‹ç¼©

### è‡ªåŠ¨å‹ç¼©

æ•°æ®å¤§å°è¶…è¿‡ **100KB** æ—¶è‡ªåŠ¨ä½¿ç”¨ gzip å‹ç¼©ï¼š

```typescript
// è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨
await storageManager.save(1, largeGameData);
// ğŸ“¦ æ•°æ®å‹ç¼©: 250000 -> 65000 bytes (74.0%)
```

### æ‰‹åŠ¨å‹ç¼©

```typescript
import { compressData, decompressData } from '@/services/compression';

// å‹ç¼©
const compressed = compressData(gameData);
console.log(compressed);
// {
//   compressed: true,
//   data: "H4sIAAAAAAAA...",  // base64
//   originalSize: 250000,
//   compressedSize: 65000
// }

// è§£å‹
const original = decompressData(compressed);
```

---

## â˜ï¸ äº‘åŒæ­¥åŠŸèƒ½

### å¯ç”¨äº‘åŒæ­¥

```typescript
const storage = new StorageManager({
  mode: 'indexeddb',
  username: 'Player123',
  enableCloudSync: true,  // å¯ç”¨äº‘åŒæ­¥
});

// ä¿å­˜æ—¶è‡ªåŠ¨ä¸Šä¼ åˆ°äº‘ç«¯
await storage.save(1, gameState);
// âœ… æ¸¸æˆå·²ä¿å­˜åˆ°æ§½ä½ 1
// â˜ï¸ å·²åŒæ­¥åˆ°äº‘ç«¯
```

### æ‰‹åŠ¨åŒæ­¥æ“ä½œ

```typescript
import { CloudSyncClient } from '@/services/cloudSync';

const syncClient = new CloudSyncClient({ username: 'Player123' });

// ä¸Šä¼ åˆ°äº‘ç«¯
await syncClient.uploadToCloud(1, gameData);
// âœ… å­˜æ¡£å·²ä¸Šä¼ åˆ°äº‘ç«¯ (ç‰ˆæœ¬ 5)

// ä»äº‘ç«¯ä¸‹è½½
const cloudData = await syncClient.downloadFromCloud(1);

// ä¸‹è½½ç‰¹å®šç‰ˆæœ¬
const oldVersion = await syncClient.downloadFromCloud(1, 3);

// è·å–åŒæ­¥å†å²
const history = await syncClient.getSyncHistory(1, 10);
console.log(history);
// [
//   { sync_version: 5, synced_at: 1697000005000, ... },
//   { sync_version: 4, synced_at: 1697000004000, ... },
//   ...
// ]
```

### å†²çªæ£€æµ‹å’Œè§£å†³

```typescript
// æ£€æŸ¥å†²çª
const conflict = await syncClient.checkConflict(1, localVersion, localTimestamp);

if (conflict.hasConflict) {
  console.log('æ£€æµ‹åˆ°å†²çªï¼');
  console.log(`æœ¬åœ°ç‰ˆæœ¬: ${localVersion}, äº‘ç«¯ç‰ˆæœ¬: ${conflict.cloudVersion}`);
  
  // æ™ºèƒ½åŒæ­¥ï¼ˆè‡ªåŠ¨è§£å†³å†²çªï¼‰
  const result = await syncClient.syncSave(1, localData, localVersion, localTimestamp);
  
  if (result.action === 'uploaded') {
    console.log('æœ¬åœ°æ•°æ®å·²ä¸Šä¼ ');
  } else if (result.action === 'downloaded') {
    console.log('å·²ä¸‹è½½äº‘ç«¯æ•°æ®:', result.data);
  }
}
```

---

## ğŸ—„ï¸ IndexedDB è¯¦è§£

### åˆå§‹åŒ–

```typescript
import { initIndexedDB } from '@/services/indexedDB';

// åˆå§‹åŒ–æ•°æ®åº“ï¼ˆè‡ªåŠ¨è°ƒç”¨ï¼‰
const db = await initIndexedDB();
// âœ… IndexedDB initialized
```

### ç›´æ¥æ“ä½œ

```typescript
import {
  saveToIndexedDB,
  loadFromIndexedDB,
  getAllSaveSlots,
  deleteFromIndexedDB,
  renameSaveInIndexedDB,
  getStorageUsage,
} from '@/services/indexedDB';

// ä¿å­˜
await saveToIndexedDB(1, gameData, 'æˆ‘çš„å­˜æ¡£');

// åŠ è½½
const data = await loadFromIndexedDB(1);

// è·å–æ‰€æœ‰æ§½ä½
const slots = await getAllSaveSlots();

// åˆ é™¤
await deleteFromIndexedDB(1);

// é‡å‘½å
await renameSaveInIndexedDB(1, 'æ–°åç§°');

// æŸ¥çœ‹å­˜å‚¨ä½¿ç”¨æƒ…å†µ
const usage = await getStorageUsage();
console.log(usage);
// {
//   usage: 1048576,           // 1MB
//   quota: 52428800,          // 50MB
//   usagePercent: 2,
//   formattedUsage: '1.00 MB',
//   formattedQuota: '50.00 MB'
// }
```

---

## ğŸ”„ å¯¼å‡º/å¯¼å…¥åŠŸèƒ½

### å¯¼å‡ºå­˜æ¡£

```typescript
// å¯¼å‡ºä¸ºJSONå­—ç¬¦ä¸²
const json = await storageManager.exportSave(1);

// ä¿å­˜åˆ°æ–‡ä»¶
const blob = new Blob([json], { type: 'application/json' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `save-slot-1-${Date.now()}.json`;
a.click();
```

### å¯¼å…¥å­˜æ¡£

```typescript
// ä»æ–‡ä»¶è¯»å–
const file = event.target.files[0];
const json = await file.text();

// å¯¼å…¥åˆ°æ§½ä½2
await storageManager.importSave(2, json, 'å¯¼å…¥çš„å­˜æ¡£');
// âœ… å­˜æ¡£å¯¼å…¥æˆåŠŸ
```

---

## ğŸ® åœ¨æ¸¸æˆä¸­é›†æˆ

### 1. åˆå§‹åŒ–å­˜å‚¨ç®¡ç†å™¨

```typescript
// src/main.tsx æˆ– App.tsx
import { storageManager } from '@/services/storageManager';

// é…ç½®å­˜å‚¨ç®¡ç†å™¨
const username = import.meta.env.VITE_USERNAME || 'Player';
const storageMode = import.meta.env.VITE_STORAGE_MODE || 'indexeddb';

storageManager.switchMode(storageMode);
```

### 2. ä¿å­˜æ¸¸æˆ

```typescript
// åœ¨ gameStore.ts æˆ–ç»„ä»¶ä¸­
import { useGameStore } from '@/store/gameStore';
import { storageManager } from '@/services/storageManager';

const saveGame = async (slotNumber: number) => {
  const state = useGameStore.getState();
  
  // å‡†å¤‡è¦ä¿å­˜çš„æ•°æ®
  const saveData = {
    player: state.player,
    playerPosition: state.playerPosition,
    inventory: state.inventory,
    quests: state.quests,
    progress: state.progress,
    settings: state.settings,
  };
  
  try {
    await storageManager.save(slotNumber, saveData, 'å½“å‰æ¸¸æˆ');
    console.log('âœ… æ¸¸æˆä¿å­˜æˆåŠŸï¼');
  } catch (error) {
    console.error('âŒ ä¿å­˜å¤±è´¥:', error);
  }
};
```

### 3. åŠ è½½æ¸¸æˆ

```typescript
const loadGame = async (slotNumber: number) => {
  try {
    const saveData = await storageManager.load(slotNumber);
    
    // æ›´æ–°æ¸¸æˆçŠ¶æ€
    useGameStore.setState({
      player: saveData.player,
      playerPosition: saveData.playerPosition,
      inventory: saveData.inventory,
      quests: saveData.quests,
      progress: saveData.progress,
      settings: saveData.settings,
    });
    
    console.log('âœ… æ¸¸æˆåŠ è½½æˆåŠŸï¼');
  } catch (error) {
    console.error('âŒ åŠ è½½å¤±è´¥:', error);
  }
};
```

### 4. è‡ªåŠ¨ä¿å­˜

```typescript
// è®¾ç½®è‡ªåŠ¨ä¿å­˜ï¼ˆæ¯5åˆ†é’Ÿï¼‰
useEffect(() => {
  const autoSave = setInterval(async () => {
    await saveGame(1);  // è‡ªåŠ¨ä¿å­˜åˆ°æ§½ä½1
  }, 5 * 60 * 1000);  // 5åˆ†é’Ÿ
  
  return () => clearInterval(autoSave);
}, []);
```

---

## ğŸ“¡ æœåŠ¡å™¨API

### ä¿å­˜åˆ°æœåŠ¡å™¨

```typescript
import { SaveAPI } from '@/services/cloudSync';

const api = new SaveAPI('Player123');

// ä¿å­˜
await api.saveGame(1, gameData, 'æˆ‘çš„å­˜æ¡£');

// åŠ è½½
const data = await api.loadGame(1);

// è·å–æ§½ä½åˆ—è¡¨
const slots = await api.getSaveSlots();

// åˆ é™¤
await api.deleteSave(1);

// é‡å‘½å
await api.renameSave(1, 'æ–°åç§°');
```

---

## ğŸ”§ é«˜çº§é…ç½®

### åˆ‡æ¢å­˜å‚¨æ¨¡å¼

```typescript
// è¿è¡Œæ—¶åˆ‡æ¢
storageManager.switchMode('cloud');  // åˆ‡æ¢åˆ°äº‘ç«¯æ¨¡å¼
storageManager.switchMode('local');  // åˆ‡æ¢åˆ°LocalStorage
storageManager.switchMode('indexeddb');  // åˆ‡æ¢åˆ°IndexedDB
```

### è·å–å­˜å‚¨ä¿¡æ¯

```typescript
const info = await storageManager.getStorageInfo();
console.log(info);
// {
//   usage: 1048576,
//   quota: 52428800,
//   usagePercent: 2,
//   formattedUsage: '1.00 MB',
//   formattedQuota: '50.00 MB'
// }
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æµè§ˆå™¨å…¼å®¹æ€§

- **IndexedDB**: æ‰€æœ‰ç°ä»£æµè§ˆå™¨æ”¯æŒ
- **LocalStorage**: æ‰€æœ‰æµè§ˆå™¨æ”¯æŒ
- **æ•°æ®å‹ç¼©**: éœ€è¦æ”¯æŒ `pako` åº“

### 2. æ•°æ®å¤§å°é™åˆ¶

| å­˜å‚¨æ–¹å¼ | é™åˆ¶ |
|---------|------|
| LocalStorage | ~5-10MB |
| IndexedDB | è‡³å°‘50MBï¼Œé€šå¸¸æ›´å¤š |
| Cloud | æ— é™åˆ¶ï¼ˆå—æœåŠ¡å™¨é…ç½®å½±å“ï¼‰ |

### 3. æ€§èƒ½å»ºè®®

- ä½¿ç”¨ IndexedDB ä½œä¸ºä¸»è¦å­˜å‚¨
- å¯ç”¨æ•°æ®å‹ç¼©
- å®šæœŸæ¸…ç†æ—§çš„äº‘åŒæ­¥è®°å½•
- å¤§å‹å­˜æ¡£åˆ†å—ä¿å­˜

### 4. å®‰å…¨æ€§

- äº‘åŒæ­¥ä½¿ç”¨ SHA-256 æ ¡éªŒæ•°æ®å®Œæ•´æ€§
- ä¸åœ¨å®¢æˆ·ç«¯å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- ä½¿ç”¨ HTTPS ä¼ è¾“æ•°æ®

---

## ğŸ› æ•…éšœæ’é™¤

### IndexedDB åˆå§‹åŒ–å¤±è´¥

```typescript
// è‡ªåŠ¨é™çº§åˆ° LocalStorage
if (error) {
  console.log('é™çº§åˆ°LocalStorageæ¨¡å¼');
  storageManager.switchMode('local');
}
```

### äº‘åŒæ­¥å¤±è´¥

```typescript
try {
  await syncClient.uploadToCloud(1, gameData);
} catch (error) {
  console.warn('äº‘åŒæ­¥å¤±è´¥ï¼ˆå°†åœ¨åå°é‡è¯•ï¼‰:', error);
  // æ•°æ®ä»ç„¶ä¿å­˜åœ¨æœ¬åœ°
}
```

### å­˜æ¡£æŸå

```typescript
try {
  const data = await storageManager.load(1);
} catch (error) {
  console.error('å­˜æ¡£å¯èƒ½å·²æŸå');
  // å°è¯•ä»äº‘ç«¯æ¢å¤
  const cloudData = await syncClient.downloadFromCloud(1);
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å‹ç¼©ç‡ç»Ÿè®¡

```typescript
import { calculateCompressionRatio, formatSize } from '@/services/compression';

const ratio = calculateCompressionRatio(originalSize, compressedSize);
console.log(`å‹ç¼©ç‡: ${ratio.toFixed(1)}%`);
console.log(`åŸå§‹å¤§å°: ${formatSize(originalSize)}`);
console.log(`å‹ç¼©å: ${formatSize(compressedSize)}`);
```

### æ‰¹é‡æ“ä½œ

```typescript
// æ‰¹é‡ä¿å­˜å¤šä¸ªæ§½ä½
await Promise.all([
  storageManager.save(1, data1),
  storageManager.save(2, data2),
  storageManager.save(3, data3),
]);
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [åç«¯APIæ–‡æ¡£](../backend/README.md)
- [è¿ç§»æŒ‡å—](../MIGRATION_GUIDE.md)
- [é¡¹ç›®é‡æ„è¯´æ˜](../PROJECT_RESTRUCTURE.md)

---

**"æ•°æ®æ°¸ä¸ä¸¢å¤±ï¼Œå†’é™©æ°¸ä¸åœæ­‡ï¼"** ğŸ’¾âœ¨
