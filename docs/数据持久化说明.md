# 💾 数据持久化说明

> **实现时间**: 2025-10-20  
> **存储方式**: LocalStorage  
> **存储位置**: 浏览器本地存储

---

## 📦 数据存储位置

### 浏览器 LocalStorage
数据存储在浏览器的 **LocalStorage** 中，路径如下：

```
浏览器 -> 开发者工具 (F12) -> Application -> Local Storage -> http://localhost:5173
```

**存储键名**: `forgotten-realm-storage`

---

## 📊 存储的数据内容

### ✅ 会被持久化的数据

#### 1. 玩家数据 (player)
```typescript
{
  level: number;           // 玩家等级
  exp: number;             // 当前经验值
  expToNextLevel: number;  // 升级所需经验
  health: number;          // 当前生命值
  maxHealth: number;       // 最大生命值
  mana: number;            // 当前魔力值
  maxMana: number;         // 最大魔力值
  attack: number;          // 攻击力
  defense: number;         // 防御力
  speed: number;           // 移动速度
  skills: string[];        // 已学习的技能ID列表
  equippedItems: {         // 装备的物品
    weapon?: Item;
    armor?: Item;
    accessory?: Item;
  };
}
```

**示例数据**：
```json
{
  "level": 1,
  "exp": 0,
  "expToNextLevel": 100,
  "health": 100,
  "maxHealth": 100,
  "mana": 80,
  "maxMana": 80,
  "attack": 10,
  "defense": 5,
  "speed": 100,
  "skills": ["fireball"],
  "equippedItems": {}
}
```

---

#### 2. 玩家位置 (playerPosition) ⭐ 核心
```typescript
{
  x: number;  // 世界坐标 X (0-2000)
  y: number;  // 世界坐标 Y (0-2000)
}
```

**示例数据**：
```json
{
  "x": 400,
  "y": 300
}
```

**作用**: 
- 下次进入游戏时，玩家会出现在上次离开的位置
- 避免每次都从起点开始

---

#### 3. 背包数据 (inventory)
```typescript
{
  items: (Item | null)[];  // 20个物品槽位
  maxSlots: number;        // 最大槽位数
}
```

**Item 结构**：
```typescript
{
  id: string;           // 物品ID
  name: string;         // 物品名称
  description: string;  // 物品描述
  type: string;         // 类型：weapon/armor/consumable/material/quest
  rarity: string;       // 稀有度：common/uncommon/rare/epic/legendary
  stats?: object;       // 属性加成
  stackable: boolean;   // 是否可堆叠
  maxStack: number;     // 最大堆叠数量
}
```

**示例数据**：
```json
{
  "items": [
    {
      "id": "health_potion",
      "name": "生命药水",
      "description": "恢复50点生命值",
      "type": "consumable",
      "rarity": "common",
      "stackable": true,
      "maxStack": 99
    },
    null,
    null,
    // ... 18个空槽位
  ],
  "maxSlots": 20
}
```

---

#### 4. 任务数据 (quests)
```typescript
Quest[] = {
  id: string;           // 任务ID
  title: string;        // 任务标题
  description: string;  // 任务描述
  type: string;         // 类型：main/side/daily
  status: string;       // 状态：available/active/completed/failed
  objectives: [];       // 任务目标
  rewards: [];          // 任务奖励
}
```

**示例数据**：
```json
[
  {
    "id": "tutorial_quest",
    "title": "新手指引",
    "description": "探索周围的世界",
    "type": "main",
    "status": "active",
    "objectives": [
      {
        "id": "explore_5_areas",
        "description": "探索5个区域",
        "current": 3,
        "required": 5,
        "completed": false
      }
    ],
    "rewards": [
      {
        "type": "exp",
        "value": 100
      }
    ]
  }
]
```

---

#### 5. 游戏进度 (progress) ⭐ 核心
```typescript
{
  exploredAreas: string[];      // 已探索区域列表（最重要）
  killedBosses: string[];       // 已击败的Boss
  unlockedSkills: string[];     // 已解锁的技能
  completedQuests: string[];    // 已完成的任务ID
  discoveredItems: string[];    // 已发现的物品ID
}
```

**exploredAreas 格式**：`"tileX-tileY"`（64像素网格坐标）

**示例数据**：
```json
{
  "exploredAreas": [
    "6-4",   // 坐标 (384,256) 的区域
    "6-5",   // 坐标 (384,320) 的区域
    "7-4",   // 坐标 (448,256) 的区域
    "7-5",
    // ... 更多已探索区域
  ],
  "killedBosses": [],
  "unlockedSkills": ["fireball"],
  "completedQuests": [],
  "discoveredItems": []
}
```

**探索区域计算**：
```javascript
// 玩家位置 (400, 300)
const areaX = Math.floor(400 / 64); // = 6
const areaY = Math.floor(300 / 64); // = 4
const areaKey = "6-4";
```

---

#### 6. 游戏设置 (settings)
```typescript
{
  volume: {
    master: number;  // 主音量 (0.0-1.0)
    music: number;   // 音乐音量
    sfx: number;     // 音效音量
  };
  graphics: {
    fullscreen: boolean;  // 全屏模式
    vsync: boolean;       // 垂直同步
  };
  controls: {
    [key: string]: string;  // 自定义按键绑定
  };
}
```

**示例数据**：
```json
{
  "volume": {
    "master": 1.0,
    "music": 0.8,
    "sfx": 0.8
  },
  "graphics": {
    "fullscreen": false,
    "vsync": true
  },
  "controls": {}
}
```

---

### ❌ 不会被持久化的数据

以下数据是**临时状态**，每次启动游戏时会重置：

#### 1. 游戏状态
```typescript
{
  isPlaying: boolean;      // 是否正在游戏（每次都是 false）
  isPaused: boolean;       // 是否暂停（每次都是 false）
  currentScene: string;    // 当前场景（每次都是 'menu'）
}
```

**原因**: 每次启动都应该回到主菜单，而不是直接进入游戏

---

#### 2. UI 显示状态
```typescript
{
  ui: {
    showInventory: boolean;   // 背包是否显示
    showSkillTree: boolean;   // 技能树是否显示
    showQuestLog: boolean;    // 任务日志是否显示
    showMap: boolean;         // 地图是否显示
  }
}
```

**原因**: UI窗口应该默认关闭，用户按键时再打开

---

## 🔍 如何查看存储的数据

### 方法1：浏览器开发者工具
1. 启动游戏 `npm run dev`
2. 按 `F12` 打开开发者工具
3. 切换到 **Application** 标签
4. 左侧展开 **Local Storage** → `http://localhost:5173`
5. 找到键名 `forgotten-realm-storage`
6. 查看 **Value** 列的 JSON 数据

### 方法2：控制台命令
在浏览器控制台输入：
```javascript
// 读取数据
console.log(JSON.parse(localStorage.getItem('forgotten-realm-storage')));

// 清空数据
localStorage.removeItem('forgotten-realm-storage');

// 修改特定数据（谨慎使用）
const data = JSON.parse(localStorage.getItem('forgotten-realm-storage'));
data.state.player.level = 99;
localStorage.setItem('forgotten-realm-storage', JSON.stringify(data));
```

---

## 📈 数据大小估算

### 初始状态
- **大小**: ~2 KB
- **包含**: 默认玩家数据、空背包、初始设置

### 游戏1小时后
- **大小**: ~5-10 KB
- **包含**: 探索100-200个区域、若干物品、任务进度

### 游戏10小时后
- **大小**: ~20-50 KB
- **包含**: 探索500-1000个区域、满背包物品、多个任务

**注意**: LocalStorage 上限通常是 **5-10 MB**，完全够用

---

## 🔄 数据同步机制

### 自动保存
- **触发时机**: 
  - 玩家移动到新区域时
  - 获得物品时
  - 任务状态改变时
  - 设置修改时
  
- **保存方式**: 
  - Zustand 自动同步到 LocalStorage
  - 无需手动调用保存函数

### 自动加载
- **触发时机**: 页面刷新或重新打开
- **加载方式**: Zustand 自动从 LocalStorage 读取
- **失败处理**: 如果数据损坏，使用默认值

---

## 🛡️ 数据安全性

### 版本控制
```typescript
{
  version: 1,  // 当前版本
}
```

**作用**:
- 未来更新时可以进行数据迁移
- 例如 v1 → v2，可以添加新字段或转换旧数据

### 数据验证
- Zustand + TypeScript 自动类型检查
- 无效数据会被重置为默认值

### 数据备份建议
1. 定期导出数据：
   ```javascript
   // 导出
   const backup = localStorage.getItem('forgotten-realm-storage');
   console.log(backup); // 复制保存
   
   // 导入
   localStorage.setItem('forgotten-realm-storage', backup);
   location.reload();
   ```

2. 使用浏览器的"导出/导入"功能

---

## 🧪 测试持久化功能

### 测试步骤
1. 启动游戏并进入游戏场景
2. 使用 WASD 移动玩家，探索几个区域
3. 按 M 键打开地图，确认探索区域显示
4. **刷新页面** (F5)
5. 重新进入游戏
6. 按 M 键打开地图

**预期结果**:
- ✅ 玩家出现在上次离开的位置
- ✅ 地图上显示之前探索的区域
- ✅ 探索进度保留

---

## 📝 实现细节

### 代码位置
- **文件**: `src/store/gameStore.ts`
- **行数**: 3行导入 + 14行配置 = **17行代码**

### 配置说明
```typescript
import { persist } from 'zustand/middleware';

export const useGameStore = create<GameState>()(
  persist(
    immer((set, get) => ({ /* 状态和actions */ })),
    {
      name: 'forgotten-realm-storage',  // 存储键名
      partialize: (state) => ({         // 选择性持久化
        player: state.player,
        playerPosition: state.playerPosition,
        inventory: state.inventory,
        quests: state.quests,
        progress: state.progress,
        settings: state.settings,
      }),
      version: 1,  // 版本号
    }
  )
);
```

---

## 🎯 优化建议

### 短期（已完成）
- ✅ 基础持久化实现
- ✅ 选择性数据保存

### 中期（1-2周）
- [ ] 添加数据压缩（大于100KB时）
- [ ] 实现多存档槽位（存档1/2/3）
- [ ] 添加云同步功能

### 长期（1-2月）
- [ ] 使用 IndexedDB 替代 LocalStorage（更大容量）
- [ ] 实现自动备份机制
- [ ] 添加数据加密

---

## 🔗 相关文档

- [Zustand Persist 文档](https://github.com/pmndrs/zustand#persist-middleware)
- [LocalStorage MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/localStorage)
- [已完成功能总结](./已完成功能总结.md)
- [下一步优化计划](./下一步优化计划.md)

---

**"数据永不丢失，冒险永不停歇！"** 💾✨
