# 🏘️ 村庄系统 v2.0 实现说明

> 完成时间：2025-10-20  
> 实现功能：泉水回血、多村庄、探索解锁、村庄传送

---

## ✅ 已实现功能

### 1️⃣ 泉水回血系统
**功能**: 在村庄内自动恢复生命值

**实现要点**:
- 每帧检测玩家是否在村庄内
- 在村庄内且未满血时自动回血
- 回血速度：5 HP/秒
- 显示绿色浮动数字提示

**代码位置**: `src/game/scenes/GameScene.ts`
```typescript
private healPlayerInSpring(village, delta) {
  const healRate = 5; // 每秒5点
  const healAmount = (healRate * delta) / 1000;
  const newHealth = Math.min(maxHealth, currentHealth + healAmount);
  // 更新血量到 store
}
```

---

### 2️⃣ 多村庄系统
**功能**: 支持多个不同规模的村庄

**村庄配置**:
```typescript
villages = [
  {
    id: 'starter_village',
    name: '起始村庄',
    x: 400, y: 300,
    radius: 150,
    size: 'medium',
    unlocked: true,
    hasSpring: true,
    hasTeleport: false,
  },
  {
    id: 'forest_village',
    name: '森林村庄',
    x: 1200, y: 800,
    radius: 100,
    size: 'small',
    unlocked: false,
    hasSpring: true,
    hasTeleport: true,
  },
  {
    id: 'mountain_village',
    name: '山脚村庄',
    x: 800, y: 1500,
    radius: 200,
    size: 'large',
    unlocked: false,
    hasSpring: true,
    hasTeleport: true,
  },
]
```

**规模对比**:
| 规模 | 半径 | 示例 |
|------|------|------|
| 小型 | 100px | 森林村庄 |
| 中型 | 150px | 起始村庄 |
| 大型 | 200px | 山脚村庄 |

---

### 3️⃣ 探索解锁系统
**功能**: 靠近未解锁村庄时自动发现

**解锁流程**:
```
1. 玩家移动时检测位置
2. 计算与未解锁村庄的距离
3. 距离 < (村庄半径 + 50) → 解锁
4. 显示解锁提示动画
5. 创建村庄视觉标记
```

**代码实现**:
```typescript
private checkVillageUnlock(x, y) {
  this.villages.forEach(village => {
    if (village.unlocked) return;
    
    const distance = Distance.Between(x, y, village.x, village.y);
    const discoverRange = village.radius + 50;
    
    if (distance < discoverRange) {
      village.unlocked = true;
      this.showVillageUnlockNotification(village);
      this.createVillages(); // 重新创建村庄标记
    }
  });
}
```

**解锁特效**:
- 屏幕中央黄色大字提示
- 村庄位置黄色闪光（范围扩散）
- 控制台日志
- 自动创建村庄视觉元素

---

### 4️⃣ 村庄传送系统
**功能**: 在已解锁村庄间快速移动

**使用条件**:
- 玩家必须在有传送点的村庄
- 目标村庄必须已解锁
- 目标村庄必须有传送点

**传送流程**:
```
1. 按 T 键触发传送
2. 检查当前位置和传送条件
3. 获取可传送目标列表
4. 播放传送特效（起点）
5. 延迟 0.5 秒
6. 移动玩家到目标村庄
7. 播放传送特效（终点）
```

**代码实现**:
```typescript
private handleTeleport() {
  // 检查条件
  const playerCheck = this.isInVillage(player.x, player.y);
  if (!playerCheck.inVillage) return;
  
  // 获取可传送目标
  const targets = this.villages.filter(v => 
    v.unlocked && v.hasTeleport && v.id !== current.id
  );
  
  // 传送
  this.showTeleportEffect(player.x, player.y);
  this.time.delayedCall(500, () => {
    player.setPosition(target.x, target.y);
    this.showTeleportEffect(target.x, target.y);
  });
}
```

**传送特效**:
- 紫色圆形光圈扩散
- 8 个紫色粒子四散
- 持续时间：500-600ms

---

## 🎮 使用指南

### 泉水回血
```
1. 进入任意村庄（黄色圆圈内）
2. 自动开始回血（每秒+5）
3. 看到绿色 "+5" 数字
4. 满血后自动停止
```

### 探索解锁新村庄
```
1. 打开地图（M键）查看村庄位置
2. 前往目标村庄方向
3. 靠近村庄（150-250像素）
4. 自动解锁并显示提示
5. 村庄变为可见可用
```

### 村庄传送
```
1. 解锁至少2个有传送点的村庄
2. 站在有传送点的村庄中
3. 按 T 键
4. 看到紫色传送特效
5. 自动传送到另一个村庄
```

---

## 📊 技术细节

### 村庄数据结构
```typescript
interface Village {
  id: string;           // 唯一标识
  name: string;         // 显示名称
  x: number;            // X 坐标
  y: number;            // Y 坐标
  radius: number;       // 安全区半径
  size: 'small' | 'medium' | 'large'; // 规模
  unlocked: boolean;    // 是否解锁
  hasSpring: boolean;   // 是否有泉水
  hasTeleport: boolean; // 是否有传送点
}
```

### 关键方法

| 方法 | 功能 | 调用时机 |
|------|------|---------|
| `initializeVillages()` | 初始化村庄列表 | 场景创建 |
| `createVillages()` | 创建村庄视觉标记 | 初始化/解锁时 |
| `createSpring()` | 创建泉水标记 | 村庄创建时 |
| `createTeleportPoint()` | 创建传送点标记 | 村庄创建时 |
| `isInVillage()` | 检测是否在村庄内 | 每帧 |
| `healPlayerInSpring()` | 泉水回血 | 每帧（在村庄内） |
| `checkVillageUnlock()` | 检查村庄解锁 | 每次探索新区域 |
| `handleTeleport()` | 处理传送 | 按T键 |
| `showTeleportEffect()` | 显示传送特效 | 传送时 |

---

## 🎨 视觉效果

### 村庄标记
```
村庄组成：
1. 黄色半透明圆圈（安全区）
2. 村庄名称文字（顶部）
   - 格式：🏘️ 村庄名 [规模]
   - 颜色：黄色+黑色描边
3. 黄色脉动复活点（中心）
4. 泉水标记 💧（中心上方）
5. 传送点 🌀（中心下方）
6. 提示文字（底部）
```

### 泉水标记
```
组成：
- 💧 蓝色水滴图标（32px）
- 蓝色半透明圆圈（20px半径）
- 蓝色边框
- 脉动动画（0.8秒循环）
- "泉水 (自动回血)" 文字
```

### 传送点标记
```
组成：
- 🌀 紫色漩涡图标（40px）
- 紫色半透明底座（25px半径）
- 旋转动画（3秒一圈）
- 脉动效果（1秒循环）
- "传送点 (按T)" 文字
```

### 传送特效
```
效果：
- 紫色光圈从中心扩散（50px→150px）
- 8个紫色粒子向外飞散
- 持续时间：500-600ms
- 颜色：#ff00ff
```

---

## 🧪 测试方法

### 测试1：泉水回血
```
1. 进入起始村庄
2. 受伤（让敌人攻击）
3. 回到村庄
4. 观察血条自动增加
5. 看到绿色 "+5" 数字
```

### 测试2：探索解锁
```
1. 打开地图（M键）
2. 前往森林村庄 (1200, 800)
3. 靠近到150像素内
4. 看到黄色解锁提示
5. 村庄变为可见
```

### 测试3：村庄传送
```
1. 解锁森林村庄和山脚村庄
2. 站在森林村庄传送点
3. 按 T 键
4. 看到紫色传送特效
5. 传送到山脚村庄
```

---

## 📝 代码统计

### 修改文件 (1个)
- `src/game/scenes/GameScene.ts` (+280行)

### 新增方法 (9个)
- `initializeVillages()`
- `createVillages()`
- `createSpring()`
- `createTeleportPoint()`
- `healPlayerInSpring()`
- `checkVillageUnlock()`
- `showVillageUnlockNotification()`
- `handleTeleport()`
- `showTeleportEffect()`

### 更新方法 (3个)
- `isInVillage()` - 返回村庄ID
- `spawnEnemies()` - 避开所有村庄
- `update()` - 添加泉水回血和解锁检测

---

## ✅ 完成清单

- [x] 泉水回血系统
- [x] 多村庄架构
- [x] 探索解锁机制
- [x] 村庄传送功能
- [x] 视觉标记和特效
- [x] 不同规模村庄
- [x] 文档更新

---

## 🚀 后续优化

### 短期优化
- [ ] 传送菜单（选择目标村庄）
- [ ] 传送冷却时间
- [ ] 村庄背景音乐
- [ ] 村庄NPC

### 长期规划
- [ ] 村庄商店系统
- [ ] 村庄任务系统
- [ ] 村庄升级系统
- [ ] 更多村庄（5-10个）

---

**村庄系统 v2.0 实现完成！** 🏘️✨💧🌀
