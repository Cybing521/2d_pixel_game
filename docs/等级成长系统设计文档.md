# 等级成长系统设计文档

> 版本：v1.0  
> 创建时间：2025-10-20  
> 状态：设计阶段

---

## 📋 目录

1. [功能概述](#功能概述)
2. [核心设计理念](#核心设计理念)
3. [等级系统设计](#等级系统设计)
4. [属性提升机制](#属性提升机制)
5. [UI设计](#ui设计)
6. [数据结构](#数据结构)
7. [实现方案](#实现方案)
8. [用户体验流程](#用户体验流程)
9. [技术难点](#技术难点)
10. [开发计划](#开发计划)

---

## 🎯 功能概述

### 目标
实现一个灵活的等级成长系统，玩家每次升级时可以自主选择属性提升，提供个性化的角色成长路线。

### 核心特性
- ✅ 经验值获取和等级提升
- ✅ 升级时播放特效，不暂停游戏
- ✅ 升级时随机恢复HP和MP（50-100%）
- ✅ 属性点可以稍后选择，不强制立即决定
- ✅ 提供多个属性提升选项供玩家选择
- ✅ 属性提升立即生效
- ✅ 记录玩家的成长历史
- ✅ 显示未分配的属性点数量

---

## 💡 核心设计理念

### 1. 自由度与平衡
- **自由选择**：玩家可以根据玩法风格选择属性
- **无悔药机制**：选择后立即生效，不可撤销（增加策略性）
- **平衡性**：各属性提升幅度经过平衡设计

### 2. 即时反馈
- **升级奖励**：升级时立即恢复HP/MP，给予即时奖励感
- **延迟选择**：不打断战斗节奏，稍后再分配属性
- **视觉反馈**：升级动画、恢复特效、属性变化高亮
- **音效反馈**：升级音效、恢复音效、选择确认音效
- **提示系统**：未分配属性点时显示提醒图标

### 3. 战斗节奏
- **不打断战斗**：升级不暂停游戏，保持战斗流畅性
- **即时收益**：HP/MP恢复提供战术价值
- **策略选择**：可以在安全时刻再分配属性点
- **紧急回复**：升级可作为战斗中的应急手段

### 4. 成长深度
- **多样化路线**：战士、法师、坦克、敏捷等多种成长路线
- **协同效应**：某些属性组合产生额外效果
- **后期深度**：高等级提供更强大的选项

---

## 📊 等级系统设计

### 等级范围
- **最低等级**：1级（初始）
- **最高等级**：50级（可扩展）
- **经验曲线**：指数增长，后期需要更多经验

### 经验值获取

#### 主要来源
| 来源 | 经验值 | 说明 |
|------|--------|------|
| 击杀史莱姆 | 10 EXP | 基础敌人 |
| 击杀精英怪 | 50 EXP | 稀有敌人 |
| 击杀BOSS | 200 EXP | 关键战斗 |
| 完成任务 | 100-500 EXP | 根据难度 |
| 探索新区域 | 20 EXP | 首次探索奖励 |
| 净化迷雾 | 50 EXP | 清理大范围迷雾 |

#### 经验公式
```
expToNextLevel(level) = 100 * (1.5 ^ (level - 1))

等级1→2: 100 EXP
等级2→3: 150 EXP
等级3→4: 225 EXP
等级10→11: ~2900 EXP
等级20→21: ~33000 EXP
```

### 等级里程碑

| 等级 | 解锁内容 | 说明 |
|------|---------|------|
| 5级 | 第一个技能槽 | 可装备第二个主动技能 |
| 10级 | 传送功能 | 解锁村庄间传送 |
| 15级 | 第二个技能槽 | 可装备第三个主动技能 |
| 20级 | 精英技能 | 解锁高级技能选项 |
| 25级 | 装备强化 | 解锁装备升级系统 |
| 30级 | 第三个技能槽 | 可装备第四个主动技能 |
| 40级 | 终极技能 | 解锁大招技能 |
| 50级 | 满级奖励 | 特殊称号和皮肤 |

---

## ⚡ 属性提升机制

### 可选属性类型

#### 1. 基础属性
| 属性 | 图标 | 提升值 | 说明 |
|------|------|--------|------|
| 最大生命值 | ❤️ | +20 HP | 增加生存能力 |
| 最大魔力值 | 💧 | +15 MP | 增加技能使用次数 |
| 攻击力 | ⚔️ | +5 ATK | 提升物理伤害 |
| 魔法强度 | 🔮 | +5 MAG | 提升魔法伤害 |
| 防御力 | 🛡️ | +3 DEF | 减少受到的伤害 |
| 移动速度 | 👟 | +10 SPD | 提升移动速度 |

#### 2. 特殊属性
| 属性 | 图标 | 效果 | 说明 |
|------|------|------|------|
| 暴击率 | ⚡ | +3% | 增加暴击几率 |
| 暴击伤害 | 💥 | +15% | 提升暴击伤害倍数 |
| 技能冷却 | ⏱️ | -5% | 减少技能冷却时间 |
| 经验加成 | 📚 | +10% | 获得更多经验值 |
| 生命恢复 | 💚 | +2 HP/s | 每秒恢复生命 |
| 魔力恢复 | 💙 | +1 MP/s | 每秒恢复魔力 |

#### 3. 高级选项（15级以上）
| 属性 | 图标 | 效果 | 解锁等级 |
|------|------|------|---------|
| 吸血 | 🩸 | +5% | 15级 |
| 反伤 | 🔄 | +10% | 15级 |
| 闪避 | 💨 | +3% | 20级 |
| 穿透 | 🎯 | +5% | 20级 |
| 多重打击 | 🌟 | +1次 | 25级 |
| 技能强化 | ✨ | 随机 | 30级 |

### 每级提供的选项

#### 规则
- **选项数量**：每次升级提供3个随机选项
- **权重系统**：
  - 基础属性：60%概率
  - 特殊属性：30%概率
  - 高级选项：10%概率（需达到解锁等级）
- **不重复**：同一次升级的3个选项不重复
- **平衡性**：连续5级内同一属性最多出现2次

#### 示例
```
升级到2级，可选择：
选项1: ❤️ 最大生命值 +20
选项2: ⚔️ 攻击力 +5
选项3: 💧 最大魔力值 +15

升级到16级，可选择：
选项1: 🛡️ 防御力 +3
选项2: ⚡ 暴击率 +3%
选项3: 🩸 吸血 +5% (新解锁!)
```

---

## 🎨 UI设计

### 升级提示（不阻塞游戏）
```
┌─────────────────────────────────┐
│  ⭐ 等级提升！Lv.4 → Lv.5       │
│  ❤️ 恢复 75% HP                 │
│  💧 恢复 60% MP                 │
│  📊 获得1点属性点待分配          │
└─────────────────────────────────┘
     （3秒后自动消失）
```

### 未分配提示图标（HUD）
```
┌──────┐
│  ⭐  │ ← 闪烁图标
│  1   │    未分配点数
└──────┘
```

### 属性分配面板（在角色面板中）
```
┌─────────────────────────────────┐
│  📊 属性分配                     │
│  未分配点数: 1                   │
│                                  │
│   选择一项属性提升：              │
│                                  │
│  ┌────────────────────────────┐ │
│  │  ❤️ 最大生命值               │ │
│  │  +20 HP                     │ │
│  │  当前: 120 → 140            │ │
│  └────────────────────────────┘ │
│                                  │
│  ┌────────────────────────────┐ │
│  │  ⚔️ 攻击力                   │ │
│  │  +5 ATK                     │ │
│  │  当前: 15 → 20              │ │
│  └────────────────────────────┘ │
│                                  │
│  ┌────────────────────────────┐ │
│  │  ⚡ 暴击率                   │ │
│  │  +3%                        │ │
│  │  当前: 5% → 8%              │ │
│  └────────────────────────────┘ │
│                                  │
│    点击选择你想要的属性提升       │
└─────────────────────────────────┘
```

### 未分配点数提示
```
┌─────────────────────────┐
│  ⚠️ 你有1点属性未分配   │
│  点击角色面板进行分配    │
└─────────────────────────┘
```

### 升级历史（角色面板）
```
┌─────────────────────────┐
│  📊 成长历史            │
├─────────────────────────┤
│  Lv.2  ❤️ +20 HP       │
│  Lv.3  ⚔️ +5 ATK       │
│  Lv.4  💧 +15 MP       │
│  Lv.5  ❤️ +20 HP       │
│  Lv.6  ⚡ +3% 暴击     │
│  ...                    │
└─────────────────────────┘
```

### 属性面板
```
┌─────────────────────────────┐
│  角色属性 - Lv.10           │
├─────────────────────────────┤
│  ❤️  生命值: 200/200        │
│  💧  魔力值: 120/120        │
│  ⚔️  攻击力: 35             │
│  🔮  魔法强度: 28           │
│  🛡️  防御力: 18             │
│  👟  移动速度: 120          │
├─────────────────────────────┤
│  ⚡  暴击率: 12%            │
│  💥  暴击伤害: 150%         │
│  ⏱️  技能冷却: -10%         │
│  📚  经验加成: +20%         │
└─────────────────────────────┘
```

---

## 💾 数据结构

### 未分配属性点
```typescript
interface PlayerProgress {
  level: number;
  exp: number;
  expToNextLevel: number;
  unallocatedPoints: number;  // 未分配的属性点
  pendingOptions: LevelUpOption[][]; // 每个未分配点的选项
}
```

### 升级恢复
```typescript
interface LevelUpReward {
  healthRestore: number;  // 恢复的HP百分比 (50-100)
  manaRestore: number;    // 恢复的MP百分比 (50-100)
}

function generateLevelUpReward(): LevelUpReward {
  return {
    healthRestore: 50 + Math.random() * 50,  // 50-100%
    manaRestore: 50 + Math.random() * 50,     // 50-100%
  };
}
```

### 玩家属性扩展
```typescript
interface PlayerStats {
  // 基础属性
  maxHealth: number;
  health: number;
  maxMana: number;
  mana: number;
  attack: number;
  magic: number;
  defense: number;
  speed: number;
  
  // 特殊属性
  critRate: number;          // 暴击率 (0-100)
  critDamage: number;        // 暴击伤害倍数 (100 = 1x)
  cooldownReduction: number; // 技能冷却减少 (0-100)
  expBonus: number;          // 经验加成 (0-100)
  healthRegen: number;       // 生命恢复/秒
  manaRegen: number;         // 魔力恢复/秒
  
  // 高级属性
  lifeSteal: number;         // 吸血 (0-100)
  thorns: number;            // 反伤 (0-100)
  dodge: number;             // 闪避 (0-100)
  penetration: number;       // 穿透 (0-100)
  multiHit: number;          // 多重打击次数
}
```

### 升级选项
```typescript
interface LevelUpOption {
  id: string;
  type: 'basic' | 'special' | 'advanced';
  statType: keyof PlayerStats;
  value: number;
  displayName: string;
  icon: string;
  description: string;
  requiredLevel: number;
}
```

### 成长历史
```typescript
interface GrowthHistory {
  level: number;
  chosenOption: LevelUpOption;
  timestamp: number;
}

interface PlayerProgress {
  level: number;
  exp: number;
  expToNextLevel: number;
  growthHistory: GrowthHistory[];
  totalStatsGained: Partial<PlayerStats>;
}
```

---

## 🔧 实现方案

### Phase 1: 核心系统（2-3小时）

#### 1.1 经验值和升级系统
```typescript
// src/systems/LevelSystem.ts
class LevelSystem {
  calculateExpToNextLevel(level: number): number;
  addExp(amount: number): void;
  checkLevelUp(): boolean;
  handleLevelUp(): void;
  generateLevelUpReward(): { healthRestore: number; manaRestore: number };
  applyLevelUpReward(reward: LevelUpReward): void;
  addUnallocatedPoint(): void;
  consumeUnallocatedPoint(option: LevelUpOption): void;
}
```

#### 1.2 属性计算
```typescript
// src/systems/StatCalculator.ts
class StatCalculator {
  calculateTotalStats(baseStats: PlayerStats, bonuses: Partial<PlayerStats>): PlayerStats;
  applyStatBonus(stat: keyof PlayerStats, value: number): void;
}
```

### Phase 2: 选项生成（1-2小时）

#### 2.1 选项池
```typescript
// src/data/levelUpOptions.ts
const LEVEL_UP_OPTIONS: LevelUpOption[] = [
  {
    id: 'hp_boost',
    type: 'basic',
    statType: 'maxHealth',
    value: 20,
    displayName: '最大生命值',
    icon: '❤️',
    description: '增加20点最大生命值',
    requiredLevel: 1,
  },
  // ... more options
];
```

#### 2.2 随机选择算法
```typescript
function generateLevelUpOptions(
  currentLevel: number,
  recentChoices: string[]
): LevelUpOption[] {
  // 1. 过滤可用选项（等级要求）
  // 2. 应用权重系统
  // 3. 避免重复
  // 4. 返回3个选项
}
```

### Phase 3: UI实现（2-3小时）

#### 3.1 升级提示组件（Toast）
```typescript
// src/ui/components/LevelUpToast.tsx
export const LevelUpToast: React.FC = () => {
  // 显示升级信息
  // 显示恢复量
  // 3秒后自动消失
  // 不阻塞游戏
};
```

#### 3.2 未分配点数图标
```typescript
// src/ui/components/UnallocatedPointsIndicator.tsx
export const UnallocatedPointsIndicator: React.FC = () => {
  // 显示未分配点数
  // 闪烁动画
  // 点击打开角色面板
};
```

#### 3.3 属性分配面板
```typescript
// src/ui/components/AttributeAllocationPanel.tsx
export const AttributeAllocationPanel: React.FC = () => {
  // 在角色面板内
  // 显示未分配点数
  // 显示3个选项
  // 处理选择
};
```

#### 3.4 属性面板扩展
```typescript
// src/ui/components/CharacterPanel.tsx
// 显示详细属性
// 显示成长历史
// 显示属性对比
```

### Phase 4: 集成测试（1小时）

- 测试经验值获取
- 测试升级流程
- 测试属性生效
- 测试数据持久化

---

## 🎮 用户体验流程

### 1. 获得经验值
```
击杀敌人 → 显示 +10 EXP → 经验条增长
```

### 2. 升级触发（不暂停游戏）
```
经验值满 → 播放升级特效 → 随机恢复HP/MP → 显示升级提示
           ↓
         游戏继续进行（不暂停）
           ↓
    未分配属性点图标闪烁
```

### 3. 稍后选择属性（玩家主动触发）
```
打开角色面板 → 点击"分配属性"按钮 → 查看3个选项 → 对比属性 → 点击选择
```

### 4. 属性生效
```
确认选择 → 属性立即更新 → 显示属性变化 → 未分配点数-1
```

### 5. 查看成长
```
打开角色面板 → 查看当前属性 → 查看成长历史 → 查看未分配点数
```

### 6. 升级恢复机制
```
升级触发 → 随机恢复50-100% HP → 随机恢复50-100% MP → 特效显示
```

---

## 🎯 技术难点

### 1. 恢复量随机性
**难点**：如何确保随机恢复既有惊喜感又不破坏平衡

**解决方案**：
- 恢复范围固定在50-100%
- 使用正态分布，大部分在70-80%
- 显示具体恢复量给予反馈
- 低概率触发100%恢复（完美升级）

### 2. 选项平衡性
**难点**：如何确保各属性的提升幅度平衡

**解决方案**：
- 制作属性价值表
- 参考同类游戏
- 通过测试调整数值
- 提供重置功能（后期）

### 3. 随机算法
**难点**：避免连续出现相同选项，保持新鲜感

**解决方案**：
- 记录最近5次选择
- 降低已选择属性的权重
- 保证多样性的同时保持随机性

### 4. 数值膨胀
**难点**：高等级时属性过高，破坏平衡

**解决方案**：
- 使用递减增长曲线
- 后期提供百分比提升而非固定值
- 敌人强度同步增长

### 5. 未分配点数管理
**难点**：玩家忘记分配属性点

**解决方案**：
- HUD显示未分配点数
- 闪烁动画提醒
- 打开背包/地图时也显示提示
- 战斗结束后弹出温馨提示

### 6. UI性能
**难点**：升级弹窗可能卡顿

**解决方案**：
- 提前预加载选项数据
- 使用动画优化
- 避免不必要的重渲染

---

## 📅 开发计划

### 第一阶段：核心系统（预计3小时）
- [x] 设计文档编写
- [ ] LevelSystem类实现
- [ ] 经验值获取和计算
- [ ] 升级检测逻辑
- [ ] 随机恢复机制
- [ ] 未分配点数管理
- [ ] 属性提升数据结构

### 第二阶段：选项系统（预计2小时）
- [ ] 定义所有升级选项
- [ ] 实现选项生成算法
- [ ] 权重和平衡调整
- [ ] 选项池管理

### 第三阶段：UI实现（预计3小时）
- [ ] LevelUpToast组件（升级提示）
- [ ] UnallocatedPointsIndicator（未分配点数图标）
- [ ] AttributeAllocationPanel（属性分配面板）
- [ ] 升级动画和恢复特效
- [ ] 属性选择交互
- [ ] 成长历史展示

### 第四阶段：集成测试（预计2小时）
- [ ] 功能测试
- [ ] 数值平衡测试
- [ ] 性能测试
- [ ] 用户体验优化

**总计工作量**：10小时

---

## 🎨 视觉设计

### 配色方案
- **升级特效**：金黄色粒子效果
- **HP恢复**：绿色上升数字+治疗光环
- **MP恢复**：蓝色上升数字+魔力光环
- **未分配图标**：橙色闪烁
- **基础属性**：蓝色系
- **特殊属性**：紫色系
- **高级属性**：金色系
- **选中状态**：发光边框

### 动画效果
- **升级**：角色闪光 → 光圈扩散 → HP/MP恢复特效 → Toast提示淡入
- **恢复特效**：绿色/蓝色数字上浮 → 粒子效果 → 渐隐
- **未分配提示**：图标闪烁（每2秒） → 缩放动画
- **选择**：选项放大 → 高亮 → 确认音效
- **属性变化**：数字滚动 → 颜色闪烁 → 恢复正常

---

## 📊 数值平衡参考

### 属性价值表
| 属性 | 单位价值 | 说明 |
|------|---------|------|
| 1 HP | 1.0 | 基准 |
| 1 MP | 0.8 | 略低于HP |
| 1 ATK | 4.0 | 直接影响伤害 |
| 1 DEF | 3.0 | 减伤效果 |
| 1% 暴击率 | 5.0 | 稀有属性 |
| 1% 吸血 | 8.0 | 高级属性 |

### 成长路线示例

#### 战士型
```
侧重：HP、ATK、DEF
等级10属性：
- HP: 240 (+120)
- ATK: 45 (+30)
- DEF: 30 (+18)
```

#### 法师型
```
侧重：MP、MAG、冷却
等级10属性：
- MP: 200 (+90)
- MAG: 50 (+32)
- 冷却: -20%
```

#### 敏捷型
```
侧重：SPD、暴击、闪避
等级10属性：
- SPD: 180 (+60)
- 暴击率: 20%
- 闪避: 12%
```

---

## 🔗 相关系统

### 与其他系统的关联

#### 1. 战斗系统
- 攻击力影响伤害计算
- 暴击系统集成
- 防御力减伤计算

#### 2. 技能系统
- 冷却减少生效
- 魔法强度影响技能伤害
- 技能强化选项

#### 3. 装备系统（未来）
- 装备属性叠加
- 装备强化解锁
- 套装效果

#### 4. 成就系统（未来）
- 成长路线成就
- 满级成就
- 特殊组合成就

---

## ✅ 验收标准

### 功能完整性
- [ ] 击杀敌人获得经验
- [ ] 经验值正确累计
- [ ] 升级时不暂停游戏
- [ ] 升级时随机恢复HP/MP（50-100%）
- [ ] 显示恢复量和特效
- [ ] 记录未分配属性点
- [ ] HUD显示未分配点数图标
- [ ] 打开角色面板可分配属性
- [ ] 提供3个不重复选项
- [ ] 选择后属性立即生效
- [ ] 未分配点数正确减少
- [ ] 成长历史正确记录
- [ ] 数据持久化保存

### 用户体验
- [ ] 升级不打断战斗
- [ ] 恢复特效明显
- [ ] 未分配提示清晰
- [ ] 升级动画流畅
- [ ] 选项清晰易懂
- [ ] 属性变化有反馈
- [ ] 操作响应灵敏
- [ ] 无明显卡顿

### 数值平衡
- [ ] 各选项价值相当
- [ ] 不存在必选项
- [ ] 成长曲线合理
- [ ] 高低等级都有挑战

---

## 📝 后续扩展

### v2.0 功能
- [ ] 技能升级选项
- [ ] 天赋树系统
- [ ] 属性重置功能
- [ ] 成长路线预设

### v3.0 功能
- [ ] 转职系统
- [ ] 专属被动技能
- [ ] 称号系统
- [ ] 炫酷升级特效

---

**文档版本**：v1.0  
**创建日期**：2025-10-20  
**维护者**：项目团队  
**状态**：设计完成，待实现

**开始实现前请确保所有设计细节已确认！** 📝✨🎮
