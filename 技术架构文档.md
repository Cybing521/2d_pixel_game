# 技术架构文档

## 📋 技术栈概览

### 核心技术选型

```
前端构建：Vite 5.x
游戏引擎：Phaser 3.80+
开发语言：TypeScript 5.x
状态管理：Zustand
UI框架：React 18 (仅用于菜单/UI界面)
样式方案：TailwindCSS (UI部分)
后端：Node.js + Express (可选，用于排行榜/云存档)
数据库：SQLite/PostgreSQL (可选)
部署：Vercel/Netlify (前端) + Railway (后端)
```

---

## 🎮 游戏引擎选择：Phaser 3

### 为什么选择 Phaser 3？

✅ **优势**：
- 成熟的 2D 游戏引擎，专为像素游戏优化
- 完善的物理引擎（Arcade Physics）
- 内置精灵动画、粒子系统、tilemap 支持
- 活跃的社区和丰富的文档
- 与 Vite 完美集成
- 支持 TypeScript
- 免费开源（MIT 协议）

✅ **适合本项目的原因**：
- 像素游戏是 Phaser 的强项
- 内置 Tilemap 系统适合地图生成
- 粒子系统可以实现迷雾效果
- 状态机适合敌人 AI
- 性能优秀，支持大量精灵

---

## 🏗️ 整体架构设计

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                       游戏应用层                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  React UI    │  │ Phaser Game  │  │  Zustand     │ │
│  │   Layer      │  │    Core      │  │   Store      │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│         │                 │                  │          │
│         └─────────────────┴──────────────────┘          │
│                           │                             │
├───────────────────────────┼─────────────────────────────┤
│                    核心系统层                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐         │
│  │ 战斗   │ │ 迷雾   │ │ 地图   │ │ AI     │         │
│  │ System │ │ System │ │ System │ │ System │         │
│  └────────┘ └────────┘ └────────┘ └────────┘         │
│                                                         │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐         │
│  │ 角色   │ │ 背包   │ │ 任务   │ │ 存档   │         │
│  │ System │ │ System │ │ System │ │ System │         │
│  └────────┘ └────────┘ └────────┘ └────────┘         │
│                                                         │
├─────────────────────────────────────────────────────────┤
│                    数据与资源层                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │
│  │  Game Data   │  │   Assets     │  │ LocalStorage│  │
│  │   (JSON)     │  │(Sprites/SFX) │  │   / IndexDB │  │
│  └──────────────┘  └──────────────┘  └─────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
         │                                     │
         ▼                                     ▼
┌──────────────────┐              ┌─────────────────────┐
│  Vite Build      │              │ Optional Backend    │
│  Development     │              │ (Node.js/Express)   │
└──────────────────┘              └─────────────────────┘
```

---

## 📂 项目结构

```
program1/
├── public/                          # 静态资源
│   ├── assets/                      # 游戏资源
│   │   ├── sprites/                 # 精灵图
│   │   │   ├── player/              # 玩家动画
│   │   │   ├── enemies/             # 敌人
│   │   │   ├── environment/         # 环境物件
│   │   │   └── effects/             # 特效
│   │   ├── tilesets/                # 地图贴图
│   │   ├── audio/                   # 音频
│   │   │   ├── music/               # 背景音乐
│   │   │   └── sfx/                 # 音效
│   │   └── ui/                      # UI资源
│   └── data/                        # 配置数据
│       ├── skills.json              # 技能配置
│       ├── enemies.json             # 敌人配置
│       ├── items.json               # 物品配置
│       └── maps/                    # 地图数据
│
├── src/
│   ├── main.ts                      # 入口文件
│   ├── App.tsx                      # React 根组件
│   │
│   ├── game/                        # Phaser 游戏核心
│   │   ├── index.ts                 # 游戏初始化
│   │   ├── config.ts                # Phaser 配置
│   │   │
│   │   ├── scenes/                  # 游戏场景
│   │   │   ├── BootScene.ts         # 启动场景（预加载）
│   │   │   ├── MenuScene.ts         # 主菜单
│   │   │   ├── GameScene.ts         # 主游戏场景
│   │   │   ├── UIScene.ts           # UI覆盖层
│   │   │   └── BattleScene.ts       # 战斗场景（可选）
│   │   │
│   │   ├── entities/                # 游戏实体
│   │   │   ├── Player.ts            # 玩家类
│   │   │   ├── Enemy.ts             # 敌人基类
│   │   │   ├── Projectile.ts       # 投射物
│   │   │   └── NPC.ts               # NPC类
│   │   │
│   │   ├── systems/                 # 游戏系统
│   │   │   ├── CombatSystem.ts      # 战斗系统
│   │   │   ├── FogSystem.ts         # 迷雾系统
│   │   │   ├── MagicSystem.ts       # 魔法系统
│   │   │   ├── InventorySystem.ts   # 背包系统
│   │   │   ├── QuestSystem.ts       # 任务系统
│   │   │   ├── SkillSystem.ts       # 技能系统
│   │   │   ├── AISystem.ts          # AI系统
│   │   │   ├── MapSystem.ts         # 地图系统
│   │   │   └── SaveSystem.ts        # 存档系统
│   │   │
│   │   ├── managers/                # 管理器
│   │   │   ├── ResourceManager.ts   # 资源管理
│   │   │   ├── EventManager.ts      # 事件管理
│   │   │   ├── AudioManager.ts      # 音频管理
│   │   │   └── InputManager.ts      # 输入管理
│   │   │
│   │   ├── components/              # ECS组件（可选）
│   │   │   ├── HealthComponent.ts
│   │   │   ├── PositionComponent.ts
│   │   │   └── AnimationComponent.ts
│   │   │
│   │   └── utils/                   # 工具函数
│   │       ├── math.ts              # 数学工具
│   │       ├── collision.ts         # 碰撞检测
│   │       ├── pathfinding.ts       # 寻路算法
│   │       └── random.ts            # 随机数生成
│   │
│   ├── ui/                          # React UI组件
│   │   ├── components/              # UI组件
│   │   │   ├── MainMenu.tsx         # 主菜单
│   │   │   ├── HUD.tsx              # 游戏内HUD
│   │   │   ├── Inventory.tsx        # 背包界面
│   │   │   ├── SkillTree.tsx        # 技能树
│   │   │   ├── Dialog.tsx           # 对话框
│   │   │   └── Settings.tsx         # 设置界面
│   │   │
│   │   └── hooks/                   # React Hooks
│   │       ├── useGame.ts           # 游戏状态hook
│   │       └── useInventory.ts      # 背包hook
│   │
│   ├── store/                       # Zustand状态管理
│   │   ├── gameStore.ts             # 游戏全局状态
│   │   ├── playerStore.ts           # 玩家状态
│   │   ├── inventoryStore.ts        # 背包状态
│   │   └── uiStore.ts               # UI状态
│   │
│   ├── types/                       # TypeScript 类型定义
│   │   ├── game.d.ts                # 游戏类型
│   │   ├── entities.d.ts            # 实体类型
│   │   ├── systems.d.ts             # 系统类型
│   │   └── data.d.ts                # 数据类型
│   │
│   ├── constants/                   # 常量
│   │   ├── gameConfig.ts            # 游戏配置
│   │   ├── keybindings.ts           # 按键绑定
│   │   └── balanceConfig.ts         # 数值平衡
│   │
│   └── services/                    # 外部服务
│       ├── api.ts                   # API调用
│       └── analytics.ts             # 数据统计
│
├── server/                          # 后端（可选）
│   ├── src/
│   │   ├── index.ts                 # 服务器入口
│   │   ├── routes/                  # API路由
│   │   │   ├── leaderboard.ts       # 排行榜
│   │   │   └── save.ts              # 云存档
│   │   └── db/                      # 数据库
│   │       └── schema.sql           # 数据表结构
│   │
│   └── package.json
│
├── tests/                           # 测试
│   ├── unit/                        # 单元测试
│   └── integration/                 # 集成测试
│
├── tools/                           # 开发工具
│   ├── mapEditor/                   # 地图编辑器
│   └── dataValidator/               # 数据验证器
│
├── index.html                       # HTML入口
├── package.json                     # 项目依赖
├── tsconfig.json                    # TS配置
├── vite.config.ts                   # Vite配置
└── README.md                        # 项目说明
```

---

## 🔧 技术栈详细配置

### 1. 前端核心技术

#### 1.1 Vite 配置

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
      '@game': path.resolve(__dirname, './src/game'),
      '@ui': path.resolve(__dirname, './src/ui'),
      '@assets': path.resolve(__dirname, './public/assets'),
    },
  },
  server: {
    port: 3000,
    open: true,
  },
  build: {
    target: 'esnext',
    minify: 'terser',
    rollupOptions: {
      output: {
        manualChunks: {
          phaser: ['phaser'],
          react: ['react', 'react-dom'],
        },
      },
    },
  },
});
```

#### 1.2 TypeScript 配置

```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"],
      "@game/*": ["src/game/*"],
      "@ui/*": ["src/ui/*"],
      "@assets/*": ["public/assets/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

#### 1.3 依赖包

```json
// package.json
{
  "name": "forgotten-pixel-realm",
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "test": "vitest",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0"
  },
  "dependencies": {
    "phaser": "^3.80.1",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "zustand": "^4.4.7",
    "immer": "^10.0.3",
    "uuid": "^9.0.1"
  },
  "devDependencies": {
    "@types/react": "^18.2.43",
    "@types/react-dom": "^18.2.17",
    "@vitejs/plugin-react": "^4.2.1",
    "typescript": "^5.3.3",
    "vite": "^5.0.8",
    "vitest": "^1.0.4",
    "eslint": "^8.55.0",
    "@typescript-eslint/eslint-plugin": "^6.14.0",
    "@typescript-eslint/parser": "^6.14.0",
    "tailwindcss": "^3.4.0",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.32"
  }
}
```

---

## 🎯 核心系统架构

### 1. Phaser 游戏初始化

```typescript
// src/game/index.ts
import Phaser from 'phaser';
import { BootScene } from './scenes/BootScene';
import { MenuScene } from './scenes/MenuScene';
import { GameScene } from './scenes/GameScene';
import { UIScene } from './scenes/UIScene';

export class Game {
  private game: Phaser.Game;

  constructor(parent: string) {
    const config: Phaser.Types.Core.GameConfig = {
      type: Phaser.AUTO,
      width: 1280,
      height: 720,
      parent,
      backgroundColor: '#2d2d2d',
      pixelArt: true, // 关键：像素游戏必须开启
      antialias: false,
      roundPixels: true,
      physics: {
        default: 'arcade',
        arcade: {
          gravity: { x: 0, y: 0 }, // 俯视角无重力
          debug: process.env.NODE_ENV === 'development',
        },
      },
      scene: [BootScene, MenuScene, GameScene, UIScene],
      scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH,
      },
    };

    this.game = new Phaser.Game(config);
  }

  destroy() {
    this.game.destroy(true);
  }
}
```

### 2. 场景管理

#### GameScene 主游戏场景

```typescript
// src/game/scenes/GameScene.ts
import Phaser from 'phaser';
import { Player } from '../entities/Player';
import { FogSystem } from '../systems/FogSystem';
import { CombatSystem } from '../systems/CombatSystem';

export class GameScene extends Phaser.Scene {
  private player!: Player;
  private fogSystem!: FogSystem;
  private combatSystem!: CombatSystem;
  private map!: Phaser.Tilemaps.Tilemap;

  constructor() {
    super({ key: 'GameScene' });
  }

  create() {
    // 创建地图
    this.createMap();
    
    // 创建玩家
    this.player = new Player(this, 400, 300);
    
    // 初始化系统
    this.fogSystem = new FogSystem(this);
    this.combatSystem = new CombatSystem(this);
    
    // 相机跟随
    this.cameras.main.startFollow(this.player, true, 0.1, 0.1);
    this.cameras.main.setZoom(2); // 放大显示像素
  }

  update(time: number, delta: number) {
    this.player.update(time, delta);
    this.fogSystem.update(time, delta);
    this.combatSystem.update(time, delta);
  }

  private createMap() {
    // 加载Tilemap
    this.map = this.make.tilemap({ key: 'map-forest' });
    const tileset = this.map.addTilesetImage('terrain', 'tiles-terrain');
    
    // 创建图层
    const groundLayer = this.map.createLayer('Ground', tileset!);
    const wallLayer = this.map.createLayer('Walls', tileset!);
    
    // 设置碰撞
    wallLayer?.setCollisionByProperty({ collides: true });
  }
}
```

### 3. 实体系统（玩家示例）

```typescript
// src/game/entities/Player.ts
import Phaser from 'phaser';

export class Player extends Phaser.Physics.Arcade.Sprite {
  private cursors!: Phaser.Types.Input.Keyboard.CursorKeys;
  private speed = 100;
  private health = 100;
  private maxHealth = 100;
  private mana = 80;
  private maxMana = 80;

  constructor(scene: Phaser.Scene, x: number, y: number) {
    super(scene, x, y, 'player', 0);
    
    scene.add.existing(this);
    scene.physics.add.existing(this);
    
    this.setCollideWorldBounds(true);
    this.createAnimations();
    this.setupInput();
  }

  private createAnimations() {
    // 行走动画（4方向）
    this.anims.create({
      key: 'walk-down',
      frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
      frameRate: 8,
      repeat: -1,
    });
    
    this.anims.create({
      key: 'walk-up',
      frames: this.anims.generateFrameNumbers('player', { start: 4, end: 7 }),
      frameRate: 8,
      repeat: -1,
    });
    
    // ... 其他方向
  }

  private setupInput() {
    this.cursors = this.scene.input.keyboard!.createCursorKeys();
  }

  update(time: number, delta: number) {
    // 移动逻辑
    let velocityX = 0;
    let velocityY = 0;

    if (this.cursors.left.isDown) velocityX = -this.speed;
    else if (this.cursors.right.isDown) velocityX = this.speed;

    if (this.cursors.up.isDown) velocityY = -this.speed;
    else if (this.cursors.down.isDown) velocityY = this.speed;

    // 标准化对角线速度
    if (velocityX !== 0 && velocityY !== 0) {
      velocityX *= 0.707;
      velocityY *= 0.707;
    }

    this.setVelocity(velocityX, velocityY);

    // 播放动画
    if (velocityY > 0) this.anims.play('walk-down', true);
    else if (velocityY < 0) this.anims.play('walk-up', true);
    else if (velocityX !== 0) this.anims.play('walk-side', true);
    else this.anims.stop();
  }

  takeDamage(amount: number) {
    this.health = Math.max(0, this.health - amount);
    // 触发受伤效果
    this.scene.events.emit('player-damaged', this.health);
  }

  heal(amount: number) {
    this.health = Math.min(this.maxHealth, this.health + amount);
  }
}
```

### 4. 迷雾系统

```typescript
// src/game/systems/FogSystem.ts
import Phaser from 'phaser';

export class FogSystem {
  private scene: Phaser.Scene;
  private fogLayer!: Phaser.GameObjects.RenderTexture;
  private exploredMap: Set<string> = new Set();
  private fogDensity = 0.8; // 迷雾密度

  constructor(scene: Phaser.Scene) {
    this.scene = scene;
    this.createFogLayer();
  }

  private createFogLayer() {
    const { width, height } = this.scene.sys.game.config;
    
    // 创建渲染纹理作为迷雾遮罩
    this.fogLayer = this.scene.add.renderTexture(
      0, 0, 
      Number(width) * 2, 
      Number(height) * 2
    );
    
    // 初始化为完全迷雾
    this.fogLayer.fill(0x000000, this.fogDensity);
    this.fogLayer.setDepth(1000); // 置于顶层
  }

  /**
   * 清除指定位置的迷雾
   */
  clearFog(x: number, y: number, radius: number) {
    // 使用圆形遮罩清除迷雾
    const graphics = this.scene.make.graphics({});
    graphics.fillStyle(0x000000);
    graphics.fillCircle(x, y, radius);
    
    this.fogLayer.erase(graphics, x - radius, y - radius);
    graphics.destroy();
    
    // 记录已探索区域
    const gridX = Math.floor(x / 16);
    const gridY = Math.floor(y / 16);
    this.exploredMap.add(`${gridX},${gridY}`);
  }

  /**
   * 迷雾再生（高级功能）
   */
  regenerateFog(x: number, y: number, radius: number) {
    const graphics = this.scene.make.graphics({});
    graphics.fillStyle(0x000000, this.fogDensity * 0.5); // 半强度再生
    graphics.fillCircle(x, y, radius);
    
    this.fogLayer.draw(graphics, x - radius, y - radius);
    graphics.destroy();
  }

  update(time: number, delta: number) {
    // 每帧更新迷雾（如动态迷雾）
    // 可以添加呼吸效果、流动效果等
  }

  isExplored(x: number, y: number): boolean {
    const gridX = Math.floor(x / 16);
    const gridY = Math.floor(y / 16);
    return this.exploredMap.has(`${gridX},${gridY}`);
  }
}
```

### 5. 魔法系统

```typescript
// src/game/systems/MagicSystem.ts
import Phaser from 'phaser';
import { Player } from '../entities/Player';

interface Skill {
  id: string;
  name: string;
  element: 'fire' | 'ice' | 'thunder' | 'nature';
  manaCost: number;
  cooldown: number;
  effect: (target: Phaser.Math.Vector2) => void;
}

export class MagicSystem {
  private scene: Phaser.Scene;
  private player: Player;
  private skills: Map<string, Skill> = new Map();
  private cooldowns: Map<string, number> = new Map();
  private lastCastTime: Map<string, number> = new Map();

  constructor(scene: Phaser.Scene, player: Player) {
    this.scene = scene;
    this.player = player;
    this.loadSkills();
  }

  private loadSkills() {
    // 火球术
    this.skills.set('fireball', {
      id: 'fireball',
      name: '火球术',
      element: 'fire',
      manaCost: 10,
      cooldown: 1000, // 1秒冷却
      effect: (target) => this.castFireball(target),
    });

    // 冰霜新星
    this.skills.set('frostnova', {
      id: 'frostnova',
      name: '冰霜新星',
      element: 'ice',
      manaCost: 15,
      cooldown: 3000,
      effect: (target) => this.castFrostNova(target),
    });
  }

  castSkill(skillId: string, target: Phaser.Math.Vector2): boolean {
    const skill = this.skills.get(skillId);
    if (!skill) return false;

    // 检查冷却
    const now = this.scene.time.now;
    const lastCast = this.lastCastTime.get(skillId) || 0;
    if (now - lastCast < skill.cooldown) return false;

    // 检查魔力
    if (this.player.mana < skill.manaCost) return false;

    // 施放技能
    skill.effect(target);
    this.player.mana -= skill.manaCost;
    this.lastCastTime.set(skillId, now);

    return true;
  }

  private castFireball(target: Phaser.Math.Vector2) {
    // 创建火球投射物
    const fireball = this.scene.physics.add.sprite(
      this.player.x,
      this.player.y,
      'fireball'
    );
    
    fireball.setScale(2);
    
    // 计算方向
    const angle = Phaser.Math.Angle.Between(
      this.player.x,
      this.player.y,
      target.x,
      target.y
    );
    
    // 设置速度
    this.scene.physics.velocityFromRotation(
      angle,
      300,
      fireball.body!.velocity
    );
    
    // 3秒后销毁
    this.scene.time.delayedCall(3000, () => fireball.destroy());
  }

  private castFrostNova(target: Phaser.Math.Vector2) {
    // AOE冰霜效果
    const radius = 100;
    const graphics = this.scene.add.graphics();
    
    graphics.fillStyle(0x00ffff, 0.3);
    graphics.fillCircle(this.player.x, this.player.y, radius);
    
    // 0.5秒后消失
    this.scene.time.delayedCall(500, () => graphics.destroy());
    
    // 对范围内敌人造成伤害和减速
    // ... 伤害逻辑
  }

  /**
   * 魔法融合系统（高级）
   */
  tryFusion(skill1: string, skill2: string): string | null {
    const fusionMap: Record<string, string> = {
      'fireball+frostnova': 'steam_explosion',
      'fireball+lightning': 'plasma_ball',
      // ... 更多组合
    };
    
    const key1 = `${skill1}+${skill2}`;
    const key2 = `${skill2}+${skill1}`;
    
    return fusionMap[key1] || fusionMap[key2] || null;
  }
}
```

### 6. 状态管理（Zustand）

```typescript
// src/store/gameStore.ts
import { create } from 'zustand';
import { immer } from 'zustand/middleware/immer';

interface GameState {
  isPlaying: boolean;
  isPaused: boolean;
  currentScene: string;
  
  // 玩家数据
  player: {
    level: number;
    exp: number;
    health: number;
    maxHealth: number;
    mana: number;
    maxMana: number;
    skills: string[];
  };
  
  // 背包
  inventory: {
    items: Item[];
    maxSlots: number;
  };
  
  // 任务
  quests: Quest[];
  
  // 游戏进度
  progress: {
    exploredAreas: string[];
    killedBosses: string[];
    unlockedSkills: string[];
  };
  
  // Actions
  startGame: () => void;
  pauseGame: () => void;
  saveGame: () => void;
  loadGame: (saveData: any) => void;
}

export const useGameStore = create<GameState>()(
  immer((set, get) => ({
    isPlaying: false,
    isPaused: false,
    currentScene: 'menu',
    
    player: {
      level: 1,
      exp: 0,
      health: 100,
      maxHealth: 100,
      mana: 80,
      maxMana: 80,
      skills: ['fireball'],
    },
    
    inventory: {
      items: [],
      maxSlots: 20,
    },
    
    quests: [],
    
    progress: {
      exploredAreas: [],
      killedBosses: [],
      unlockedSkills: ['fireball'],
    },
    
    startGame: () => set({ isPlaying: true, currentScene: 'game' }),
    
    pauseGame: () => set((state) => {
      state.isPaused = !state.isPaused;
    }),
    
    saveGame: () => {
      const state = get();
      const saveData = {
        player: state.player,
        inventory: state.inventory,
        quests: state.quests,
        progress: state.progress,
        timestamp: Date.now(),
      };
      localStorage.setItem('game-save', JSON.stringify(saveData));
    },
    
    loadGame: (saveData) => set((state) => {
      Object.assign(state, saveData);
    }),
  }))
);
```

### 7. React UI 集成

```typescript
// src/ui/components/HUD.tsx
import React from 'react';
import { useGameStore } from '@/store/gameStore';

export const HUD: React.FC = () => {
  const player = useGameStore((state) => state.player);
  
  return (
    <div className="fixed inset-0 pointer-events-none">
      {/* 左上角：生命和魔力 */}
      <div className="absolute top-4 left-4 pointer-events-auto">
        <div className="bg-black/50 p-3 rounded-lg border border-white/20">
          {/* 生命条 */}
          <div className="mb-2">
            <div className="flex items-center gap-2 mb-1">
              <span className="text-red-400 text-sm">❤️ HP</span>
              <span className="text-white text-sm">
                {player.health}/{player.maxHealth}
              </span>
            </div>
            <div className="w-48 h-2 bg-gray-700 rounded-full overflow-hidden">
              <div
                className="h-full bg-red-500 transition-all"
                style={{ width: `${(player.health / player.maxHealth) * 100}%` }}
              />
            </div>
          </div>
          
          {/* 魔力条 */}
          <div>
            <div className="flex items-center gap-2 mb-1">
              <span className="text-blue-400 text-sm">💧 MP</span>
              <span className="text-white text-sm">
                {player.mana}/{player.maxMana}
              </span>
            </div>
            <div className="w-48 h-2 bg-gray-700 rounded-full overflow-hidden">
              <div
                className="h-full bg-blue-500 transition-all"
                style={{ width: `${(player.mana / player.maxMana) * 100}%` }}
              />
            </div>
          </div>
        </div>
      </div>
      
      {/* 右下角：技能栏 */}
      <div className="absolute bottom-4 right-4 flex gap-2 pointer-events-auto">
        {player.skills.map((skill, i) => (
          <div
            key={skill}
            className="w-12 h-12 bg-gray-800 rounded border-2 border-white/30
                       flex items-center justify-center cursor-pointer
                       hover:border-yellow-400 transition-colors"
          >
            <span className="text-xs text-white">{i + 1}</span>
          </div>
        ))}
      </div>
    </div>
  );
};
```

---

## 💾 数据存储方案

### 1. 本地存储（LocalStorage）

```typescript
// src/game/systems/SaveSystem.ts
export class SaveSystem {
  private static SAVE_KEY = 'forgotten-pixel-realm-save';
  
  static save(data: SaveData): void {
    const saveData = {
      version: '1.0.0',
      timestamp: Date.now(),
      data,
    };
    localStorage.setItem(this.SAVE_KEY, JSON.stringify(saveData));
  }
  
  static load(): SaveData | null {
    const saved = localStorage.getItem(this.SAVE_KEY);
    if (!saved) return null;
    
    try {
      const { data } = JSON.parse(saved);
      return data;
    } catch (error) {
      console.error('Failed to load save:', error);
      return null;
    }
  }
  
  static delete(): void {
    localStorage.removeItem(this.SAVE_KEY);
  }
  
  static exists(): boolean {
    return localStorage.getItem(this.SAVE_KEY) !== null;
  }
}

interface SaveData {
  player: PlayerData;
  inventory: InventoryData;
  progress: ProgressData;
  settings: SettingsData;
}
```

### 2. IndexedDB（大量数据）

```typescript
// src/services/database.ts
import { openDB, DBSchema, IDBPDatabase } from 'idb';

interface GameDB extends DBSchema {
  saves: {
    key: string;
    value: SaveData;
  };
  achievements: {
    key: string;
    value: Achievement;
  };
}

class Database {
  private db!: IDBPDatabase<GameDB>;
  
  async init() {
    this.db = await openDB<GameDB>('game-db', 1, {
      upgrade(db) {
        db.createObjectStore('saves');
        db.createObjectStore('achievements');
      },
    });
  }
  
  async saveSave(id: string, data: SaveData) {
    await this.db.put('saves', data, id);
  }
  
  async loadSave(id: string) {
    return await this.db.get('saves', id);
  }
  
  async getAllSaves() {
    return await this.db.getAll('saves');
  }
}

export const db = new Database();
```

### 3. 云存档（可选后端）

```typescript
// server/src/routes/save.ts
import express from 'express';
import { db } from '../db';

const router = express.Router();

// 上传存档
router.post('/save', async (req, res) => {
  const { userId, saveData } = req.body;
  
  try {
    await db.query(
      'INSERT INTO saves (user_id, data, updated_at) VALUES (?, ?, NOW())',
      [userId, JSON.stringify(saveData)]
    );
    res.json({ success: true });
  } catch (error) {
    res.status(500).json({ error: 'Failed to save' });
  }
});

// 下载存档
router.get('/save/:userId', async (req, res) => {
  const { userId } = req.params;
  
  try {
    const [rows] = await db.query(
      'SELECT data FROM saves WHERE user_id = ? ORDER BY updated_at DESC LIMIT 1',
      [userId]
    );
    res.json({ data: rows[0]?.data });
  } catch (error) {
    res.status(500).json({ error: 'Failed to load' });
  }
});

export default router;
```

---

## 🎨 资源管理

### 资源加载策略

```typescript
// src/game/managers/ResourceManager.ts
export class ResourceManager {
  private scene: Phaser.Scene;
  private loadedAssets: Set<string> = new Set();
  
  constructor(scene: Phaser.Scene) {
    this.scene = scene;
  }
  
  /**
   * 预加载核心资源
   */
  preloadCore() {
    // 玩家
    this.scene.load.spritesheet('player', '/assets/sprites/player.png', {
      frameWidth: 16,
      frameHeight: 24,
    });
    
    // UI
    this.scene.load.image('ui-panel', '/assets/ui/panel.png');
    
    // 音效
    this.scene.load.audio('step', '/assets/audio/sfx/step.mp3');
  }
  
  /**
   * 按需加载区域资源
   */
  async loadArea(areaId: string) {
    if (this.loadedAssets.has(areaId)) return;
    
    // 动态加载该区域的资源
    switch (areaId) {
      case 'forest':
        this.scene.load.tilemapTiledJSON('map-forest', '/data/maps/forest.json');
        this.scene.load.image('tiles-forest', '/assets/tilesets/forest.png');
        break;
      
      case 'mine':
        this.scene.load.tilemapTiledJSON('map-mine', '/data/maps/mine.json');
        this.scene.load.image('tiles-mine', '/assets/tilesets/mine.png');
        break;
    }
    
    await this.scene.load.start();
    this.loadedAssets.add(areaId);
  }
  
  /**
   * 卸载不用的资源（优化内存）
   */
  unloadArea(areaId: string) {
    // 移除纹理和缓存
    this.scene.textures.remove(`tiles-${areaId}`);
    this.loadedAssets.delete(areaId);
  }
}
```

---

## 🚀 性能优化策略

### 1. 对象池

```typescript
// src/game/utils/ObjectPool.ts
export class ObjectPool<T extends Phaser.GameObjects.GameObject> {
  private pool: T[] = [];
  private creator: () => T;
  
  constructor(creator: () => T, initialSize = 10) {
    this.creator = creator;
    
    // 预创建对象
    for (let i = 0; i < initialSize; i++) {
      const obj = creator();
      obj.setActive(false).setVisible(false);
      this.pool.push(obj);
    }
  }
  
  get(): T {
    let obj = this.pool.find(o => !o.active);
    
    if (!obj) {
      obj = this.creator();
      this.pool.push(obj);
    }
    
    obj.setActive(true).setVisible(true);
    return obj;
  }
  
  release(obj: T) {
    obj.setActive(false).setVisible(false);
  }
}

// 使用示例
const projectilePool = new ObjectPool(() => 
  scene.add.sprite(0, 0, 'projectile')
);

// 获取对象
const projectile = projectilePool.get();
projectile.setPosition(x, y);

// 释放对象
projectilePool.release(projectile);
```

### 2. 视野剔除

```typescript
// src/game/systems/CullingSystem.ts
export class CullingSystem {
  private camera: Phaser.Cameras.Scene2D.Camera;
  private entities: Phaser.GameObjects.GameObject[] = [];
  
  constructor(camera: Phaser.Cameras.Scene2D.Camera) {
    this.camera = camera;
  }
  
  register(entity: Phaser.GameObjects.GameObject) {
    this.entities.push(entity);
  }
  
  update() {
    const bounds = this.camera.worldView;
    
    for (const entity of this.entities) {
      const inView = Phaser.Geom.Rectangle.Overlaps(
        bounds,
        (entity as any).getBounds()
      );
      
      entity.setActive(inView);
      
      // 视野外的敌人暂停更新
      if (!inView && 'pauseAI' in entity) {
        (entity as any).pauseAI();
      }
    }
  }
}
```

### 3. 纹理图集

使用工具（如TexturePacker）将多个小图合成一张大图：

```json
// public/assets/sprites/atlas.json
{
  "frames": {
    "player-walk-0": { "frame": {"x":0,"y":0,"w":16,"h":24} },
    "player-walk-1": { "frame": {"x":16,"y":0,"w":16,"h":24} },
    "enemy-slime-0": { "frame": {"x":32,"y":0,"w":16,"h":16} }
  }
}
```

```typescript
// 加载图集
this.load.atlas('game-atlas', '/assets/sprites/atlas.png', '/assets/sprites/atlas.json');

// 使用
this.add.sprite(x, y, 'game-atlas', 'player-walk-0');
```

---

## 📱 部署方案

### 1. 前端部署（Vercel）

```bash
# 安装 Vercel CLI
npm install -g vercel

# 部署
vercel --prod
```

```json
// vercel.json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "devCommand": "npm run dev",
  "installCommand": "npm install"
}
```

### 2. 后端部署（Railway）

```yaml
# railway.toml
[build]
builder = "NIXPACKS"

[deploy]
startCommand = "npm start"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10
```

### 3. CDN 优化

- 使用 Cloudflare CDN 加速静态资源
- 图片使用 WebP 格式
- 启用 Gzip/Brotli 压缩

---

## 🛠️ 开发工具

### 1. 地图编辑器：Tiled

- 下载：https://www.mapeditor.org/
- 导出为 JSON 格式
- Phaser 原生支持

### 2. 像素绘图：Aseprite

```bash
# 安装（macOS）
brew install --cask aseprite

# 导出sprite sheet
aseprite -b player.ase --sheet player.png --data player.json
```

### 3. 调试工具

```typescript
// src/game/utils/Debug.ts
export class DebugPanel {
  private scene: Phaser.Scene;
  private text!: Phaser.GameObjects.Text;
  
  constructor(scene: Phaser.Scene) {
    this.scene = scene;
    this.create();
  }
  
  private create() {
    this.text = this.scene.add.text(10, 10, '', {
      fontSize: '12px',
      color: '#00ff00',
      backgroundColor: '#000000',
      padding: { x: 5, y: 5 },
    });
    this.text.setScrollFactor(0); // 固定在相机
    this.text.setDepth(10000);
  }
  
  update(player: Player) {
    this.text.setText([
      `FPS: ${Math.round(this.scene.game.loop.actualFps)}`,
      `Player: (${Math.round(player.x)}, ${Math.round(player.y)})`,
      `Health: ${player.health}/${player.maxHealth}`,
      `Entities: ${this.scene.children.length}`,
    ]);
  }
}
```

---

## 🧪 测试策略

### 单元测试（Vitest）

```typescript
// tests/unit/MagicSystem.test.ts
import { describe, it, expect } from 'vitest';
import { MagicSystem } from '@/game/systems/MagicSystem';

describe('MagicSystem', () => {
  it('should cast fireball when mana is sufficient', () => {
    const magic = new MagicSystem(mockScene, mockPlayer);
    const result = magic.castSkill('fireball', new Vector2(100, 100));
    expect(result).toBe(true);
  });
  
  it('should not cast when on cooldown', () => {
    const magic = new MagicSystem(mockScene, mockPlayer);
    magic.castSkill('fireball', new Vector2(100, 100));
    const result = magic.castSkill('fireball', new Vector2(100, 100));
    expect(result).toBe(false);
  });
});
```

### 集成测试

```typescript
// tests/integration/combat.test.ts
describe('Combat System Integration', () => {
  it('player should damage enemy on hit', () => {
    const scene = createMockScene();
    const player = new Player(scene, 0, 0);
    const enemy = new Enemy(scene, 50, 50);
    
    // 模拟攻击
    player.attack(enemy);
    
    expect(enemy.health).toBeLessThan(enemy.maxHealth);
  });
});
```

---

## 📊 性能监控

### 帧率监控

```typescript
// src/game/utils/PerformanceMonitor.ts
export class PerformanceMonitor {
  private fpsHistory: number[] = [];
  private maxHistory = 60;
  
  update(fps: number) {
    this.fpsHistory.push(fps);
    if (this.fpsHistory.length > this.maxHistory) {
      this.fpsHistory.shift();
    }
  }
  
  getAverageFPS(): number {
    const sum = this.fpsHistory.reduce((a, b) => a + b, 0);
    return sum / this.fpsHistory.length;
  }
  
  getMinFPS(): number {
    return Math.min(...this.fpsHistory);
  }
  
  // 发送到分析服务
  report() {
    const data = {
      avgFPS: this.getAverageFPS(),
      minFPS: this.getMinFPS(),
      timestamp: Date.now(),
    };
    
    // 发送到后端
    fetch('/api/analytics', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }
}
```

---

## 🎯 关键实现要点

### 1. 像素完美渲染

```typescript
// 确保像素完美
const config: Phaser.Types.Core.GameConfig = {
  pixelArt: true,
  antialias: false,
  roundPixels: true,
};

// 相机缩放使用整数倍
camera.setZoom(2); // 或 3, 4
```

### 2. 输入系统

```typescript
// src/game/managers/InputManager.ts
export class InputManager {
  private scene: Phaser.Scene;
  private keys: Map<string, Phaser.Input.Keyboard.Key> = new Map();
  
  constructor(scene: Phaser.Scene) {
    this.scene = scene;
    this.setupKeys();
  }
  
  private setupKeys() {
    const keyConfig = {
      up: 'W',
      down: 'S',
      left: 'A',
      right: 'D',
      skill1: 'ONE',
      skill2: 'TWO',
      skill3: 'THREE',
      skill4: 'FOUR',
      interact: 'E',
      inventory: 'I',
      menu: 'ESC',
    };
    
    for (const [action, key] of Object.entries(keyConfig)) {
      this.keys.set(action, this.scene.input.keyboard!.addKey(key));
    }
  }
  
  isDown(action: string): boolean {
    return this.keys.get(action)?.isDown || false;
  }
  
  onPress(action: string, callback: () => void) {
    this.keys.get(action)?.on('down', callback);
  }
}
```

### 3. 事件系统

```typescript
// src/game/managers/EventManager.ts
export class EventManager {
  private static instance: EventManager;
  private emitter: Phaser.Events.EventEmitter;
  
  private constructor() {
    this.emitter = new Phaser.Events.EventEmitter();
  }
  
  static getInstance(): EventManager {
    if (!EventManager.instance) {
      EventManager.instance = new EventManager();
    }
    return EventManager.instance;
  }
  
  emit(event: string, ...args: any[]) {
    this.emitter.emit(event, ...args);
  }
  
  on(event: string, callback: Function, context?: any) {
    this.emitter.on(event, callback, context);
  }
  
  off(event: string, callback?: Function) {
    this.emitter.off(event, callback);
  }
}

// 使用
EventManager.getInstance().emit('player-level-up', { level: 5 });
EventManager.getInstance().on('player-level-up', (data) => {
  console.log('Level up to', data.level);
});
```

---

## 📈 开发流程建议

### 第一周：环境搭建
- [x] 初始化 Vite + React + TypeScript
- [ ] 集成 Phaser 3
- [ ] 创建基础项目结构
- [ ] 实现简单的游戏循环

### 第二周：核心移动
- [ ] 玩家移动和动画
- [ ] 相机系统
- [ ] 碰撞检测
- [ ] 输入管理

### 第三周：战斗系统
- [ ] 基础攻击
- [ ] 1个魔法技能
- [ ] 简单敌人AI
- [ ] 伤害计算

### 第四周：UI集成
- [ ] HUD显示
- [ ] 背包界面
- [ ] React与Phaser通信
- [ ] 状态管理

---

## ✅ 技术验证清单

开发前需要验证：

- [ ] Vite能否正确加载Phaser资源
- [ ] TypeScript类型定义是否完善
- [ ] React与Phaser的通信是否流畅
- [ ] 像素渲染是否清晰（无模糊）
- [ ] 性能是否达标（60FPS）
- [ ] 存档系统是否可靠
- [ ] 不同屏幕尺寸适配是否正常

---

## 🔗 参考资源

### 官方文档
- Phaser 3: https://photonstorm.github.io/phaser3-docs/
- Vite: https://vitejs.dev/
- Zustand: https://zustand-demo.pmnd.rs/

### 教程
- Phaser 3 Examples: https://labs.phaser.io/
- Pixel Art Tutorial: https://lospec.com/pixel-art-tutorials
- Tiled Map Editor: https://doc.mapeditor.org/

### 社区
- Phaser Discord: https://discord.gg/phaser
- Reddit r/gamedev: https://reddit.com/r/gamedev

---

**技术架构版本**：v1.0  
**创建日期**：2025年10月15日  
**兼容性**：现代浏览器（Chrome 90+, Firefox 88+, Safari 14+）

这套技术栈成熟、文档完善、社区活跃，非常适合你的像素游戏项目！🎮✨

